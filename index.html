<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curr√≠culo de Corredores - thIAguinho Solu√ß√µes</title>
    <style>
        /* Estiliza√ß√£o id√™ntica √† V3, focada em Dark Mode e responsividade */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1f2027 0%, #3a3a52 100%); min-height: 100vh; padding: 20px; color: #f0f0f0; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(42, 42, 58, 0.85); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); }
        .header { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .auth-container { position: absolute; top: 15px; right: 20px; }
        .auth-container button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .auth-container button:hover { background: rgba(255,255,255,0.4); }
        .dashboard-section { padding: 30px; background: rgba(20, 20, 30, 0.5); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .dashboard-header { text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #c5cae9; }
        .dashboard-subheader { text-align: center; margin-bottom: 15px; color: #aaa; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #2a2a3a; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3); }
        .stat-number { font-size: 2em; font-weight: bold; color: #c5cae9; margin-bottom: 8px; line-height: 1.2; }
        .stat-label { color: #b0b0b0; font-weight: 600; font-size: 0.9em; }
        .pr-card .stat-number { font-size: 1.4em; }
        .pr-card .runner-pr { font-size: 0.9em; color: #f0f0f0; line-height: 1.5; }
        .runner-pr-thiago { color: #4dabf5; font-weight: 600; }
        .runner-pr-thamis { color: #f06292; font-weight: 600; }
        .controls-section { padding: 20px 30px; text-align: center; background: #1a1a2e; display: none; /* Escondido por padr√£o */ }
        .btn-add { padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3); }
        .history-section { padding: 30px; background: transparent; }
        .year-group { margin-bottom: 30px; }
        .year-title { font-size: 2em; color: #c5cae9; border-bottom: 3px solid #c5cae9; padding-bottom: 10px; margin-bottom: 20px; }
        .race-card-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .race-card { background: #2a2a3a; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.05); }
        .race-card.status-planned { background: #3a382a; border: 2px dashed #ffc107; }
        .race-card.status-skipped { background: #3a2a2a; opacity: 0.7; }
        .race-card-header { padding: 20px; border-bottom: 1px solid #444; }
        .race-card-header h3 { font-size: 1.3em; color: #ffffff; margin-bottom: 5px; }
        .race-card-header .date { font-size: 0.9em; color: #b0b0b0; font-weight: 600; }
        .race-card-body { padding: 20px; flex-grow: 1; }
        .runner-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #444; }
        .runner-info:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: 0; }
        .runner-info .runner-name { font-weight: bold; font-size: 1.1em; }
        .runner-name.runner1 { color: #4dabf5; }
        .runner-name.runner2 { color: #f06292; }
        .runner-details { text-align: right; }
        .runner-time { font-size: 1.2em; font-weight: 700; color: #4caf50; }
        .runner-time.goal { color: #ffc107; font-size: 1.1em; }
        .runner-time.skipped { color: #f44336; font-size: 1.1em; font-style: italic; }
        .runner-pace { font-size: 0.9em; color: #b0b0b0; font-family: monospace; }
        .runner-pace.goal { color: #ffeb3b; }
        .race-card-footer { padding: 10px 20px; background: #222230; display: flex; justify-content: space-between; align-items: center; }
        .juntos-icon { font-size: 1.5em; }
        .race-notes { font-size: 0.85em; color: #b0b0b0; font-style: italic; margin-left: 10px; }
        .race-distance { font-size: 1.1em; font-weight: bold; color: #c5cae9; margin-right: 15px; }
        .race-controls { display: flex; gap: 10px; display: none; } /* Escondido por padr√£o */
        .btn-control { background: none; border: none; cursor: pointer; font-size: 1em; color: #b0b0b0; opacity: 0.6; transition: opacity 0.3s; }
        .btn-control:hover { opacity: 1; }
        dialog { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 600px; padding: 0; overflow: hidden; background: #2a2a3a; color: #f0f0f0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        .modal-header { padding: 20px 30px; background: #1f2027; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { color: #c5cae9; }
        .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; color: #b0b0b0; font-size: 0.9em; margin-bottom: 8px; }
        .form-group input, .form-group select { padding: 12px 15px; border: 2px solid #555; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; background: #333345; color: #f0f0f0; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .form-group.checkbox { grid-column: 1 / -1; flex-direction: row; align-items: center; gap: 10px; font-size: 1.1em; }
        .form-group.checkbox input { width: 20px; height: 20px; }
        .runner-form-group { border: 2px solid #555; border-radius: 10px; padding: 15px; }
        .runner-form-group h4 { font-size: 1.2em; margin-bottom: 15px; text-align: center; }
        .runner-form-group.runner1 h4 { color: #4dabf5; }
        .runner-form-group.runner2 h4 { color: #f06292; }
        .runner-form-group .form-group { margin-bottom: 10px; }
        .runner-form-group .form-group:last-child { margin-bottom: 0; }
        .modal-footer { padding: 20px 30px; background: #1f2027; border-top: 1px solid #444; display: flex; justify-content: flex-end; gap: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        #btn-delete { background: #dc3545; color: white; margin-right: auto; }
        #btn-delete:hover { background: #c82333; }
        #btn-delete.hidden { display: none; }
        .footer { background: #1f2027; color: #aaa; text-align: center; padding: 20px; font-size: 0.9em; border-top: 1px solid #444; }
        .loader { padding: 40px; text-align: center; font-size: 1.2em; color: #c5cae9; font-weight: 600; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .race-card-list { grid-template-columns: 1fr; }
            .modal-body { grid-template-columns: 1fr; }
            .form-group.checkbox { font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-container" id="auth-container">
                <button id="auth-button">Login</button>
            </div>
            <h1>Curr√≠culo Esportivo üèÉ‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÄÔ∏è</h1>
            <p id="header-subtitle">Carregando perfil...</p>
        </div>
        <div class="dashboard-section">
            <h2 class="dashboard-header">Dashboard de Performance</h2>
            <h3 class="dashboard-subheader">Recordes Pessoais (PRs)</h3>
            <div class="stats-grid" id="pr-grid"><div class="loader">Carregando PRs...</div></div>
            <h3 class="dashboard-subheader" style="margin-top: 30px;">Estat√≠sticas Gerais</h3>
            <div class="stats-grid" id="summary-grid"><div class="loader">Calculando...</div></div>
        </div>
        <div class="controls-section" id="controls-section">
            <button class="btn-add" id="btn-add-new">‚ûï Adicionar Nova Corrida</button>
        </div>
        <div class="history-section">
            <div id="history-container"><div class="loader">Carregando hist√≥rico...</div></div>
        </div>
        <div class="footer">Desenvolvido com ü§ñ por <strong>thIAguinho Solu√ß√µes</strong></div>
    </div>

    <dialog id="race-modal">
        <form id="race-form">
            <!-- Campos do formul√°rio id√™nticos √† V3 -->
        </form>
    </dialog>

    <dialog id="login-modal">
        <form id="login-form">
             <div class="modal-header"><h2>Login de Administrador</h2></div>
             <div class="modal-body">
                <div class="form-group full-width"><label for="email">Email</label><input type="email" id="email" required></div>
                <div class="form-group full-width"><label for="password">Senha</label><input type="password" id="password" required></div>
             </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btn-cancel-login">Cancelar</button>
                <button type="submit" class="btn btn-primary">Entrar</button>
             </div>
        </form>
    </dialog>

    <!-- Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // =================================================================
        // FASE 2: INICIALIZA√á√ÉO DO FIREBASE
        // =================================================================
        const firebaseConfig = {
            // COLE SEU firebaseConfig AQUI
            apiKey: "AIzaSyAyMTzM7sem903SLJsmBeMF3XyvaeGv7Hg",
            authDomain: "curriculo-corridas-7cd4e.firebaseapp.com",
            databaseURL: "https://curriculo-corridas-7cd4e-default-rtdb.firebaseio.com",
            projectId: "curriculo-corridas-7cd4e",
            storageBucket: "curriculo-corridas-7cd4e.firebasestorage.app",
            messagingSenderId: "126737528447",
            appId: "1:126737528447:web:3d316262e3d2df9dc0f14a"
        };
        
        // =================================================================
        // ARQUITETURA V4 - L√ìGICA DE APLICA√á√ÉO (FIREBASE MULTI-TENANT)
        // =================================================================
        
        // --- Vari√°veis Globais ---
        const db = { races: {}, profile: {} };
        let appState = {
            currentUser: null,
            isAdmin: false,
            viewingUserId: null,
            RUNNER_1_CONFIG: { id: 'runner1', name: 'Corredor 1', nameShort: 'C1', class: 'runner1', emoji: 'üèÉ‚Äç‚ôÇÔ∏è' },
            RUNNER_2_CONFIG: { id: 'runner2', name: 'Corredor 2', nameShort: 'C2', class: 'runner2', emoji: 'üèÉ‚Äç‚ôÄÔ∏è' }
        };
        let firebaseApp, database, auth;
        let racesRefListener, profileRefListener; // Guarda refer√™ncias aos listeners para poder remov√™-los

        // Fun√ß√µes utilit√°rias de tempo permanecem as mesmas
        function timeToSeconds(t){if(!t||typeof t!=="string")return null;let e=t.split(":").map(Number).filter(t=>!isNaN(t)),a=0;return e.length===2?a=60*e[0]+e[1]:e.length===3?a=3600*e[0]+60*e[1]+e[2]:null,a}
        function secondsToTime(t){if(t===null||isNaN(t)||t===Infinity)return"N/A";t=Math.round(t);let e=Math.floor(t/3600),a=Math.floor(t%3600/60),r=t%60,n=t=>String(t).padStart(2,"0");return e>0?`${n(e)}:${n(a)}:${n(r)}`:`${n(a)}:${n(r)}`}
        function normalizeTime(t){if(!t)return null;let e=t.replace(/[^0-9:]/g,"").split(":");return e.length===2?`00:${String(e[0]).padStart(2,"0")}:${String(e[1]).padStart(2,"0")}`:e.length===3?`${String(e[0]).padStart(2,"0")}:${String(e[1]).padStart(2,"0")}:${String(e[2]).padStart(2,"0")}`:null}
        function calculatePace(t,e){let a=timeToSeconds(t),r=parseFloat(e);if(!a||!r||r<=0)return"N/A";let n=a/r,l=Math.floor(n/60),o=Math.round(n%60);return`${String(l).padStart(2,"0")}:${String(o).padStart(2,"0")} /km`}

        // --- Fun√ß√µes de UI ---
        function updateUIforAuthState() {
            const authButton = document.getElementById('auth-button');
            const controlsSection = document.getElementById('controls-section');
            const allRaceControls = document.querySelectorAll('.race-controls');

            if (appState.currentUser && (appState.currentUser.uid === appState.viewingUserId || appState.isAdmin)) {
                authButton.textContent = 'Logout';
                controlsSection.style.display = 'block';
                allRaceControls.forEach(c => c.style.display = 'flex');
            } else {
                authButton.textContent = 'Login';
                controlsSection.style.display = 'none';
                allRaceControls.forEach(c => c.style.display = 'none');
            }
        }
        
        function updateProfileUI() {
            if(db.profile.runner1Name && db.profile.runner2Name) {
                appState.RUNNER_1_CONFIG = { id: 'runner1', name: db.profile.runner1Name, nameShort: db.profile.runner1Name.split(' ')[0], class: 'runner1', emoji: 'üèÉ‚Äç‚ôÇÔ∏è' };
                appState.RUNNER_2_CONFIG = { id: 'runner2', name: db.profile.runner2Name, nameShort: db.profile.runner2Name.split(' ')[0], class: 'runner2', emoji: 'üèÉ‚Äç‚ôÄÔ∏è' };
            }
            document.getElementById('header-subtitle').textContent = `${appState.RUNNER_1_CONFIG.name} & ${appState.RUNNER_2_CONFIG.name}`;
            document.getElementById('runner1-form-name').innerHTML = `${appState.RUNNER_1_CONFIG.name} ${appState.RUNNER_1_CONFIG.emoji}`;
            document.getElementById('runner2-form-name').innerHTML = `${appState.RUNNER_2_CONFIG.name} ${appState.RUNNER_2_CONFIG.emoji}`;
        }
        
        function renderAll() {
            updateProfileUI();
            renderDashboard();
            renderHistory();
            updateUIforAuthState(); // Garante que os controles de edi√ß√£o sejam exibidos/ocultados corretamente
        }

        // Fun√ß√µes de renderiza√ß√£o do dashboard e hist√≥rico s√£o similares, mas usam appState.RUNNER_CONFIG
        // e agora recebem os dados como par√¢metros para serem mais puras.
        function renderDashboard(races, profile) {
            const prGrid = document.getElementById('pr-grid');
            const summaryGrid = document.getElementById('summary-grid');
            const racesArray = Object.values(races);
            
            const prs = { runner1: {}, runner2: {} };
            const distances = [2, 5, 6, 7, 10, 12, 16, 17];
            let totalKm1 = 0, totalKm2 = 0, totalRacesJuntos = 0, completedRaces1 = 0, completedRaces2 = 0;
            
            distances.forEach(d => {
                prs.runner1[d] = { time: 'N/A', seconds: Infinity };
                prs.runner2[d] = { time: 'N/A', seconds: Infinity };
            });

            racesArray.forEach(race => {
                if(race.juntos && race.runner1.status === 'completed' && race.runner2.status === 'completed') totalRacesJuntos++;

                if (race.runner1 && race.runner1.status === 'completed') {
                    completedRaces1++;
                    const dist = race.runner1.distance || race.distance;
                    const timeSec = timeToSeconds(race.runner1.time);
                    if (dist) totalKm1 += dist;
                    if (prs.runner1[dist] && timeSec < prs.runner1[dist].seconds) {
                        prs.runner1[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
                
                if (race.runner2 && race.runner2.status === 'completed') {
                    completedRaces2++;
                    const dist = race.runner2.distance || race.distance;
                    const timeSec = timeToSeconds(race.runner2.time);
                    if (dist) totalKm2 += dist;
                    if (prs.runner2[dist] && timeSec < prs.runner2[dist].seconds) {
                        prs.runner2[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
            });
            
            prGrid.innerHTML = distances.map(d => `
                <div class="stat-card pr-card">
                    <div class="stat-label">PR ${d}km</div>
                    <div class="stat-number">
                        <div class="runner-pr"><span class="runner-pr-thiago">${appState.RUNNER_1_CONFIG.nameShort}: ${prs.runner1[d].time}</span></div>
                        <div class="runner-pr"><strong class="runner-pr-thamis">${appState.RUNNER_2_CONFIG.nameShort}: ${prs.runner2[d].time}</strong></div>
                    </div>
                </div>`).join('');

            summaryGrid.innerHTML = `
                <div class="stat-card"><div class="stat-number">${completedRaces1 + completedRaces2}</div><div class="stat-label">Corridas Conclu√≠das (Total)</div></div>
                <div class="stat-card"><div class="stat-number">${totalRacesJuntos} üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</div><div class="stat-label">Corridas Juntos</div></div>
                <div class="stat-card"><div class="stat-number">${(totalKm1 + totalKm2).toFixed(1)} km</div><div class="stat-label">Total KM (Casal)</div></div>
                <div class="stat-card"><div class="stat-number"><span class="runner-pr-thiago">${totalKm1.toFixed(1)}</span> / <strong class="runner-pr-thamis">${totalKm2.toFixed(1)}</strong></div><div class="stat-label">Total KM (${appState.RUNNER_1_CONFIG.nameShort} / ${appState.RUNNER_2_CONFIG.nameShort})</div></div>`;
        }

        function renderHistory(races) {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            const sortedRaces = Object.entries(races).map(([id, race]) => ({ ...race, id })).sort((a, b) => new Date(b.date) - new Date(a.date));
            const racesByYear = sortedRaces.reduce((acc, race) => {
                const year = race.year || new Date(race.date + 'T00:00:00').getFullYear().toString();
                if (!acc[year]) acc[year] = [];
                acc[year].push(race);
                return acc;
            }, {});
            const sortedYears = Object.keys(racesByYear).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                container.innerHTML = '<div class="loader">Nenhuma corrida encontrada. Se voc√™ for o dono deste perfil, fa√ßa login para adicionar.</div>';
                return;
            }

            for (const year of sortedYears) {
                const yearGroup = document.createElement('div');
                yearGroup.className = 'year-group';
                const yearEmoji = year.split('').map(d => ['0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£'][d]).join('');
                yearGroup.innerHTML = `<h2 class="year-title">${yearEmoji} (${racesByYear[year].length} provas)</h2>`;
                
                const raceList = document.createElement('div');
                raceList.className = 'race-card-list';
                racesByYear[year].forEach(race => raceList.appendChild(createRaceCard(race)));
                
                yearGroup.appendChild(raceList);
                container.appendChild(yearGroup);
            }
        }
        
        function createRaceCard(race) {
            const card = document.createElement('div');
            let cardStatus = 'completed';
            if ((race.runner1 && race.runner1.status === 'planned') || (race.runner2 && race.runner2.status === 'planned')) cardStatus = 'planned';
            if ((!race.runner1 || race.runner1.status === 'skipped') && (!race.runner2 || race.runner2.status === 'skipped')) cardStatus = 'skipped';

            card.className = `race-card status-${cardStatus}`;
            card.dataset.id = race.id;

            const runner1Dist = (race.runner1 && race.runner1.distance) || race.distance;
            const runner2Dist = (race.runner2 && race.runner2.distance) || race.distance;
            
            const runner1Data = race.runner1 || { status: 'skipped' };
            const runner2Data = race.runner2 || { status: 'skipped' };

            const runner1Pace = calculatePace(runner1Data.status === 'completed' ? runner1Data.time : runner1Data.goalTime, runner1Dist);
            const runner2Pace = calculatePace(runner2Data.status === 'completed' ? runner2Data.time : runner2Data.goalTime, runner2Dist);

            let raceDistDisplay = '';
            if (race.distance) raceDistDisplay = `${race.distance}km`;
            else if (runner1Dist && runner2Dist && runner1Dist !== runner2Dist) raceDistDisplay = `${runner1Dist || '?'}k / ${runner2Dist || '?'}k`;
            else raceDistDisplay = `${runner1Dist || runner2Dist || '?'}km`;

            card.innerHTML = `
                <div class="race-card-header">
                    <h3>${race.raceName}</h3>
                    <span class="date">${new Date(race.date).toLocaleDateString('pt-BR', {timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric'})}</span>
                </div>
                <div class="race-card-body">
                    ${createRunnerInfoHTML(appState.RUNNER_1_CONFIG, runner1Data, runner1Dist, runner1Pace)}
                    ${createRunnerInfoHTML(appState.RUNNER_2_CONFIG, runner2Data, runner2Dist, runner2Pace)}
                </div>
                <div class="race-card-footer">
                    <div>
                        <span class="juntos-icon">${race.juntos ? 'üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª' : ''}</span>
                        <span class="race-notes">${race.notes || ''}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="race-distance">${raceDistDisplay}</span>
                        <div class="race-controls">
                            <button class="btn-control btn-edit" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-control btn-delete" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            
            card.querySelector('.btn-edit').addEventListener('click', () => openModal(race.id));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteRace(race.id));
            return card;
        }

        function createRunnerInfoHTML(config, runnerData, distance, pace) {
            let timeHTML = '', paceHTML = '';
            switch (runnerData.status) {
                case 'completed':
                    timeHTML = `<div class="runner-time">${secondsToTime(timeToSeconds(runnerData.time))}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace">${pace}</div>`;
                    break;
                case 'planned':
                    const goalTime = runnerData.goalTime || (runnerData.time && runnerData.time.includes(':') ? runnerData.time : null);
                    timeHTML = `<div class="runner-time goal">‚è≥ ${goalTime ? secondsToTime(timeToSeconds(goalTime)) : 'Planejada'}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace goal">(Meta: ${pace})</div>`;
                    break;
                case 'skipped':
                    timeHTML = `<div class="runner-time skipped">‚ùå N√£o correu</div>`;
                    break;
                default: timeHTML = `<div class="runner-time skipped">N/A</div>`;
            }
            if (runnerData.status === 'skipped') return `<div class="runner-info"><span class="runner-name ${config.class}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}</div></div>`;
            return `<div class="runner-info"><span class="runner-name ${config.class}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}${paceHTML}</div></div>`;
        }

        // --- Firebase Data Logic ---
        function loadUserData(userId) {
            appState.viewingUserId = userId;
            
            // Remove listeners antigos para evitar m√∫ltiplas execu√ß√µes
            if (profileRefListener) profileRefListener.off();
            if (racesRefListener) racesRefListener.off();

            const profileRef = firebase.database().ref(`users/${userId}/profile`);
            profileRefListener = profileRef.on('value', (snapshot) => {
                db.profile = snapshot.val() || { runner1Name: "Corredor", runner2Name: "Corredora", teamName: "Equipe" };
                updateProfileUI(); // Atualiza o header com o nome do perfil visualizado
                renderDashboard(db.races, db.profile); // Recalcula o dashboard
            });
            
            const racesRef = firebase.database().ref(`users/${userId}/races`);
            racesRefListener = racesRef.on('value', (snapshot) => {
                db.races = snapshot.val() || {};
                renderDashboard(db.races, db.profile);
                renderHistory(db.races);
                updateUIforAuthState();
            });
        }

        // --- L√≥gica de Autentica√ß√£o ---
        function handleAuthStateChanged(user) {
            appState.currentUser = user;
            if (user) {
                firebase.database().ref(`admins/${user.uid}`).once('value', snapshot => {
                    appState.isAdmin = snapshot.exists() && snapshot.val() === true;
                    updateUIforAuthState();
                });
            } else {
                appState.isAdmin = false;
                updateUIforAuthState();
            }
        }
        
        // --- Modal & Form Logic ---
        const raceModal = document.getElementById('race-modal');
        const loginModal = document.getElementById('login-modal');
        const raceForm = document.getElementById('race-form');
        const loginForm = document.getElementById('login-form');
        const modalTitle = document.getElementById('modal-title');
        const btnDelete = document.getElementById('btn-delete');
        
        function openModal(raceId = null) {
            // L√≥gica de preenchimento do modal (quase id√™ntica, mas usa runner1/runner2)
            raceForm.reset();
            document.getElementById('race-id').value = '';
            btnDelete.classList.add('hidden');
            if (raceId) {
                modalTitle.textContent = 'Editar Corrida';
                btnDelete.classList.remove('hidden');
                const race = db.races[raceId];
                if (!race) return;
                document.getElementById('race-id').value = raceId;
                document.getElementById('raceName').value = race.raceName;
                document.getElementById('raceDate').value = race.date;
                document.getElementById('raceDistance').value = race.distance;
                document.getElementById('raceJuntos').checked = race.juntos;
                document.getElementById('raceNotes').value = race.notes || '';
                
                document.getElementById('thiagoStatus').value = race.runner1.status || 'skipped';
                const runner1Time = race.runner1.status === 'completed' ? race.runner1.time : (race.runner1.goalTime || race.runner1.time || '');
                document.getElementById('thiagoTime').value = normalizeTime(runner1Time) ? secondsToTime(timeToSeconds(runner1Time)) : '';
                document.getElementById('thiagoDistance').value = race.runner1.distance || '';
                
                document.getElementById('thamisStatus').value = race.runner2.status || 'skipped';
                const runner2Time = race.runner2.status === 'completed' ? race.runner2.time : (race.runner2.goalTime || race.runner2.time || '');
                document.getElementById('thamisTime').value = normalizeTime(runner2Time) ? secondsToTime(timeToSeconds(runner2Time)) : '';
                document.getElementById('thamisDistance').value = race.runner2.distance || '';
            } else {
                modalTitle.textContent = 'Adicionar Nova Corrida';
                document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
            }
            raceModal.showModal();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (!appState.viewingUserId) return;
            const id = document.getElementById('race-id').value;
            const date = document.getElementById('raceDate').value;
            const raceData = {
                date: date,
                year: new Date(date + 'T00:00:00').getFullYear().toString(),
                raceName: document.getElementById('raceName').value,
                distance: parseFloat(document.getElementById('raceDistance').value) || null,
                juntos: document.getElementById('raceJuntos').checked,
                notes: document.getElementById('raceNotes').value || null,
                runner1: {
                    status: document.getElementById('thiagoStatus').value,
                    time: document.getElementById('thiagoStatus').value === 'completed' ? normalizeTime(document.getElementById('thiagoTime').value) : null,
                    goalTime: document.getElementById('thiagoStatus').value === 'planned' ? normalizeTime(document.getElementById('thiagoTime').value) : null,
                    distance: parseFloat(document.getElementById('thiagoDistance').value) || null
                },
                runner2: {
                    status: document.getElementById('thamisStatus').value,
                    time: document.getElementById('thamisStatus').value === 'completed' ? normalizeTime(document.getElementById('thamisTime').value) : null,
                    goalTime: document.getElementById('thamisStatus').value === 'planned' ? normalizeTime(document.getElementById('thamisTime').value) : null,
                    distance: parseFloat(document.getElementById('thamisDistance').value) || null
                }
            };
            const path = `users/${appState.viewingUserId}/races`;
            if (id) {
                firebase.database().ref(path).child(id).set(raceData).then(() => raceModal.close()).catch(console.error);
            } else {
                firebase.database().ref(path).push(raceData).then(() => raceModal.close()).catch(console.error);
            }
        }
        
        function deleteRace(raceId) {
            const race = db.races[raceId];
            if (!confirm(`Tem certeza que deseja excluir:\n\n${race.raceName}?`)) return;
            firebase.database().ref(`users/${appState.viewingUserId}/races/${raceId}`).remove().then(() => raceModal.close()).catch(console.error);
        }

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!firebaseConfig.apiKey) {
                alert("ERRO: firebaseConfig est√° vazio. Cole suas chaves do Firebase.");
                document.getElementById('history-container').innerHTML = '<div class="loader" style="color: #f44336;">ERRO: Firebase n√£o configurado.</div>';
                return;
            }
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();

            // L√≥gica de Roteamento Simples pela URL
            const params = new URLSearchParams(window.location.search);
            const userIdFromUrl = params.get('user');
            const adminId = "29d30W4RS1WzK4SWZRZ5pEFnOdm1"; // Seu UID
            
            loadUserData(userIdFromUrl || adminId);

            auth.onAuthStateChanged(handleAuthStateChanged);

            document.getElementById('auth-button').addEventListener('click', () => {
                if (appState.currentUser) auth.signOut();
                else loginModal.showModal();
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => loginModal.close())
                    .catch(err => alert("Erro no login: " + err.message));
            });
            
            document.getElementById('btn-add-new').addEventListener('click', () => openModal());
            document.getElementById('btn-close-modal').addEventListener('click', (e) => { e.preventDefault(); raceModal.close(); });
            document.getElementById('btn-cancel').addEventListener('click', (e) => { e.preventDefault(); raceModal.close(); });
            document.getElementById('btn-cancel-login').addEventListener('click', (e) => { e.preventDefault(); loginModal.close(); });
            raceForm.addEventListener('submit', handleFormSubmit);
            btnDelete.addEventListener('click', () => {
                const id = document.getElementById('race-id').value;
                if(id) deleteRace(id);
            });
        });
    </script>
</body>
</html>
