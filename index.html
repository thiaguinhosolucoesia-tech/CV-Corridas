<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curr√≠culo de Corredores - thIAguinho Solu√ß√µes</title>
    <style>
        /* ESTILIZA√á√ÉO GERAL (DARK MODE) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1f2027 0%, #3a3a52 100%); min-height: 100vh; padding: 20px; color: #f0f0f0; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(42, 42, 58, 0.85); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); }
        .header { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }

        /* DASHBOARD DE PERFORMANCE (STATS) */
        .dashboard-section { padding: 30px; background: rgba(20, 20, 30, 0.5); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .dashboard-header { text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #c5cae9; }
        .dashboard-subheader { text-align: center; margin-bottom: 15px; color: #aaa; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #2a2a3a; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3); }
        .stat-number { font-size: 2em; font-weight: bold; color: #c5cae9; margin-bottom: 8px; line-height: 1.2; }
        .stat-label { color: #b0b0b0; font-weight: 600; font-size: 0.9em; }
        .pr-card .stat-number { font-size: 1.4em; }
        .pr-card .runner-pr { font-size: 0.9em; color: #f0f0f0; line-height: 1.5; }
        .runner-pr-thiago { color: #4dabf5; font-weight: 600; }
        .runner-pr-thamis { color: #f06292; font-weight: 600; }

        /* CONTROLES E HIST√ìRICO */
        .controls-section { padding: 20px 30px; text-align: center; background: #1a1a2e; }
        .btn-add { padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3); }
        .history-section { padding: 30px; background: transparent; }
        .year-group { margin-bottom: 30px; }
        .year-title { font-size: 2em; color: #c5cae9; border-bottom: 3px solid #c5cae9; padding-bottom: 10px; margin-bottom: 20px; }
        .race-card-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .race-card { background: #2a2a3a; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.05); }
        .race-card.status-planned { background: #3a382a; border: 2px dashed #ffc107; }
        .race-card.status-skipped { background: #3a2a2a; opacity: 0.7; }
        .race-card-header { padding: 20px; border-bottom: 1px solid #444; }
        .race-card-header h3 { font-size: 1.3em; color: #ffffff; margin-bottom: 5px; }
        .race-card-header .date { font-size: 0.9em; color: #b0b0b0; font-weight: 600; }
        .race-card-body { padding: 20px; flex-grow: 1; }
        .runner-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #444; }
        .runner-info:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: 0; }
        .runner-info .runner-name { font-weight: bold; font-size: 1.1em; }
        .runner-name.thiago { color: #4dabf5; }
        .runner-name.thamis { color: #f06292; }
        .runner-details { text-align: right; }
        .runner-time { font-size: 1.2em; font-weight: 700; color: #4caf50; }
        .runner-time.goal { color: #ffc107; font-size: 1.1em; }
        .runner-time.skipped { color: #f44336; font-size: 1.1em; font-style: italic; }
        .runner-pace { font-size: 0.9em; color: #b0b0b0; font-family: monospace; }
        .runner-pace.goal { color: #ffeb3b; }
        .race-card-footer { padding: 10px 20px; background: #222230; display: flex; justify-content: space-between; align-items: center; }
        .juntos-icon { font-size: 1.5em; }
        .race-notes { font-size: 0.85em; color: #b0b0b0; font-style: italic; margin-left: 10px; }
        .race-distance { font-size: 1.1em; font-weight: bold; color: #c5cae9; margin-right: 15px; }
        .race-controls { display: flex; gap: 10px; }
        .btn-control { background: none; border: none; cursor: pointer; font-size: 1em; color: #b0b0b0; opacity: 0.6; transition: opacity 0.3s; }
        .btn-control:hover { opacity: 1; }

        /* MODAL E FORMUL√ÅRIO (DARK) */
        dialog { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 600px; padding: 0; overflow: hidden; background: #2a2a3a; color: #f0f0f0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        .modal-header { padding: 20px 30px; background: #1f2027; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { color: #c5cae9; }
        .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; color: #b0b0b0; font-size: 0.9em; margin-bottom: 8px; }
        .form-group input, .form-group select { padding: 12px 15px; border: 2px solid #555; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; background: #333345; color: #f0f0f0; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .form-group.checkbox { grid-column: 1 / -1; flex-direction: row; align-items: center; gap: 10px; font-size: 1.1em; }
        .form-group.checkbox input { width: 20px; height: 20px; }
        .runner-form-group { border: 2px solid #555; border-radius: 10px; padding: 15px; }
        .runner-form-group h4 { font-size: 1.2em; margin-bottom: 15px; text-align: center; }
        .runner-form-group.thiago h4 { color: #4dabf5; }
        .runner-form-group.thamis h4 { color: #f06292; }
        .runner-form-group .form-group { margin-bottom: 10px; }
        .runner-form-group .form-group:last-child { margin-bottom: 0; }
        .modal-footer { padding: 20px 30px; background: #1f2027; border-top: 1px solid #444; display: flex; justify-content: flex-end; gap: 15px; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        #btn-delete { background: #dc3545; color: white; margin-right: auto; }
        #btn-delete:hover { background: #c82333; }
        #btn-delete.hidden { display: none; }
        .footer { background: #1f2027; color: #aaa; text-align: center; padding: 20px; font-size: 0.9em; border-top: 1px solid #444; }

        /* Anima√ß√£o de Loading Simples */
        .loader {
            padding: 40px;
            text-align: center;
            font-size: 1.2em;
            color: #c5cae9;
            font-weight: 600;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .race-card-list { grid-template-columns: 1fr; }
            .modal-body { grid-template-columns: 1fr; }
            .form-group.checkbox { font-size: 1em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Curr√≠culo Esportivo üèÉ‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÄÔ∏è</h1>
            <p id="header-subtitle">Carregando perfil...</p>
        </div>

        <div class="dashboard-section">
            <h2 class="dashboard-header">Dashboard de Performance</h2>
            <h3 class="dashboard-subheader">Recordes Pessoais (PRs)</h3>
            <div class="stats-grid" id="pr-grid">
                <div class="loader">Carregando PRs...</div>
            </div>
            <h3 class="dashboard-subheader" style="margin-top: 30px;">Estat√≠sticas Gerais</h3>
            <div class="stats-grid" id="summary-grid">
                <div class="loader">Calculando...</div>
            </div>
        </div>

        <div class="controls-section">
            <button class="btn-add" id="btn-add-new">‚ûï Adicionar Nova Corrida</button>
        </div>

        <div class="history-section">
            <div id="history-container">
                <div class="loader">Carregando hist√≥rico do Firebase...</div>
            </div>
        </div>

        <div class="footer">
            Desenvolvido com ü§ñ por <strong>thIAguinho Solu√ß√µes</strong>
        </div>
    </div>

    <dialog id="race-modal">
        <form id="race-form">
            <input type="hidden" id="race-id">
            <div class="modal-header">
                <h2 id="modal-title">Adicionar Nova Corrida</h2>
                <button type="button" class="btn-control" id="btn-close-modal" aria-label="Fechar">‚úñÔ∏è</button>
            </div>

            <div class="modal-body">
                <div class="form-group full-width">
                    <label for="raceName">Nome da Corrida</label>
                    <input type="text" id="raceName" required>
                </div>
                <div class="form-group">
                    <label for="raceDate">Data</label>
                    <input type="date" id="raceDate" required>
                </div>
                <div class="form-group">
                    <label for="raceDistance">Dist√¢ncia (km)</label>
                    <input type="number" step="0.1" id="raceDistance" placeholder="Ex: 5 ou 10. Deixe em branco se for diferente">
                </div>

                <div class="runner-form-group thiago">
                    <h4 id="runner1-form-name">Corredor 1 üèÉ‚Äç‚ôÇÔ∏è</h4>
                    <div class="form-group">
                        <label for="thiagoStatus">Status</label>
                        <select id="thiagoStatus">
                            <option value="completed">Completou ‚úÖ</option>
                            <option value="planned">Planejada ‚è≥</option>
                            <option value="skipped">N√£o Correu ‚ùå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="thiagoTime">Tempo (HH:MM:SS)</label>
                        <input type="text" id="thiagoTime" placeholder="00:29:10">
                    </div>
                    <div class="form-group">
                        <label for="thiagoDistance">Dist√¢ncia (se diferente da prova)</label>
                        <input type="number" step="0.1" id="thiagoDistance" placeholder="Ex: 10">
                    </div>
                </div>

                <div class="runner-form-group thamis">
                    <h4 id="runner2-form-name">Corredor 2 üèÉ‚Äç‚ôÄÔ∏è</h4>
                    <div class="form-group">
                        <label for="thamisStatus">Status</label>
                        <select id="thamisStatus">
                            <option value="completed">Completou ‚úÖ</option>
                            <option value="planned">Planejada ‚è≥</option>
                            <option value="skipped">N√£o Correu ‚ùå</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="thamisTime">Tempo (HH:MM:SS)</label>
                        <input type="text" id="thamisTime" placeholder="00:40:36">
                    </div>
                    <div class="form-group">
                        <label for="thamisDistance">Dist√¢ncia (se diferente da prova)</label>
                        <input type="number" step="0.1" id="thamisDistance" placeholder="Ex: 5">
                    </div>
                </div>

                <div class="form-group checkbox">
                    <input type="checkbox" id="raceJuntos">
                    <label for="raceJuntos">Correram Juntos? üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</label>
                </div>

                <div class="form-group full-width">
                    <label for="raceNotes">Notas</label>
                    <input type="text" id="raceNotes" placeholder="Ex: Corrida com ‚ôø, meta de tempo...">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn" id="btn-delete" class="hidden">Excluir</button>
                <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="btn-save">Salvar</button>
            </div>
        </form>
    </dialog>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // =================================================================
        // FASE 2: INICIALIZA√á√ÉO DO FIREBASE
        // COPIE E COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
        // =================================================================
        const firebaseConfig = {
    apiKey: "AIzaSyAyMTzM7sem903SLJsmBeMF3XyvaeGv7Hg",
    authDomain: "curriculo-corridas-7cd4e.firebaseapp.com",
    databaseURL: "https://curriculo-corridas-7cd4e-default-rtdb.firebaseio.com",
    projectId: "curriculo-corridas-7cd4e",
    storageBucket: "curriculo-corridas-7cd4e.firebasestorage.app",
    messagingSenderId: "126737528447",
    appId: "1:126737528447:web:3d316262e3d2df9dc0f14a"
  };

        // =================================================================
        // ARQUITETURA V3 - L√ìGICA DE APLICA√á√ÉO (FIREBASE)
        // =================================================================

        // --- Configura√ß√£o dos Corredores (Ser√° carregado do Firebase) ---
        let RUNNER_1_CONFIG = { id: 'thiago', name: 'Thiago V. Valencio', nameShort: 'Thiago V.', class: 'thiago', emoji: 'üèÉ‚Äç‚ôÇÔ∏è' };
        let RUNNER_2_CONFIG = { id: 'thamis', name: 'Thamis E. P. Valencio', nameShort: 'Thamis E.', class: 'thamis', emoji: 'üèÉ‚Äç‚ôÄÔ∏è' };

        // --- Vari√°veis Globais do App ---
        const db = {
            races: {}, // Usamos um objeto para IDs do Firebase
            profile: {}
        };
        let firebaseApp, database;
        const racesRef, profileRef;

        // --- Fun√ß√µes Utilit√°rias de Tempo e Pace ---
        function timeToSeconds(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return null;
            const parts = timeStr.split(':').map(Number).filter(n => !isNaN(n));
            let seconds = 0;
            if (parts.length === 2) { seconds = parts[0] * 60 + parts[1]; }
            else if (parts.length === 3) { seconds = parts[0] * 3600 + parts[1] * 60 + parts[2]; }
            else { return null; }
            return seconds;
        }

        function secondsToTime(totalSeconds) {
            if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds === Infinity) return 'N/A';
            totalSeconds = Math.round(totalSeconds);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return (hours > 0) ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}` : `${pad(minutes)}:${pad(seconds)}`;
        }

        function normalizeTime(timeStr) {
            if (!timeStr) return null;
            const cleanTime = timeStr.replace(/[^0-9:]/g, '');
            const parts = cleanTime.split(':');
            if (parts.length === 2) { return `00:${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}`; }
            else if (parts.length === 3) { return `${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}:${String(parts[2]).padStart(2, '0')}`; }
            return null;
        }

        function calculatePace(timeStr, distance) {
            const seconds = timeToSeconds(timeStr);
            const dist = parseFloat(distance);
            if (!seconds || !dist || dist <= 0) return 'N/A';
            const paceInSeconds = seconds / dist;
            const paceMinutes = Math.floor(paceInSeconds / 60);
            const paceSeconds = Math.round(paceInSeconds % 60);
            return `${String(paceMinutes).padStart(2, '0')}:${String(paceSeconds).padStart(2, '0')} /km`;
        }

        // --- Fun√ß√µes de Renderiza√ß√£o (UI) ---

        function updateProfileUI() {
            if(db.profile.runner1 && db.profile.runner2) {
                RUNNER_1_CONFIG.name = db.profile.runner1.name;
                RUNNER_1_CONFIG.nameShort = db.profile.runner1.nameShort;
                RUNNER_2_CONFIG.name = db.profile.runner2.name;
                RUNNER_2_CONFIG.nameShort = db.profile.runner2.nameShort;
            }

            document.getElementById('header-subtitle').textContent = `${RUNNER_1_CONFIG.name} & ${RUNNER_2_CONFIG.name}`;
            document.getElementById('runner1-form-name').innerHTML = `${RUNNER_1_CONFIG.name} ${RUNNER_1_CONFIG.emoji}`;
            document.getElementById('runner2-form-name').innerHTML = `${RUNNER_2_CONFIG.name} ${RUNNER_2_CONFIG.emoji}`;
        }

        function renderDashboard() {
            const prGrid = document.getElementById('pr-grid');
            const summaryGrid = document.getElementById('summary-grid');
            const racesArray = Object.values(db.races); // Converte objeto em array

            const prs = { thiago: {}, thamis: {} };
            const distances = [2, 5, 6, 7, 10, 12, 16, 17];
            let totalKmThiago = 0, totalKmThamis = 0, totalRacesJuntos = 0, completedRacesThiago = 0, completedRacesThamis = 0;

            distances.forEach(d => {
                prs.thiago[d] = { time: 'N/A', seconds: Infinity };
                prs.thamis[d] = { time: 'N/A', seconds: Infinity };
            });

            racesArray.forEach(race => {
                if(race.juntos && race.thiago.status === 'completed' && race.thamis.status === 'completed') totalRacesJuntos++;

                if (race.thiago.status === 'completed') {
                    completedRacesThiago++;
                    const dist = race.thiago.distance || race.distance;
                    const timeSec = timeToSeconds(race.thiago.time);
                    if (dist) totalKmThiago += dist;
                    if (prs.thiago[dist] && timeSec < prs.thiago[dist].seconds) {
                        prs.thiago[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }

                if (race.thamis.status === 'completed') {
                    completedRacesThamis++;
                    const dist = race.thamis.distance || race.distance;
                    const timeSec = timeToSeconds(race.thamis.time);
                    if (dist) totalKmThamis += dist;
                    if (prs.thamis[dist] && timeSec < prs.thamis[dist].seconds) {
                        prs.thamis[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
            });

            prGrid.innerHTML = distances.map(d => `
                <div class="stat-card pr-card">
                    <div class="stat-label">PR ${d}km</div>
                    <div class="stat-number">
                        <div class="runner-pr"><span class="runner-pr-thiago">${RUNNER_1_CONFIG.nameShort}: ${prs.thiago[d].time}</span></div>
                        <div class="runner-pr"><strong class="runner-pr-thamis">${RUNNER_2_CONFIG.nameShort}: ${prs.thamis[d].time}</strong></div>
                    </div>
                </div>`).join('');

            summaryGrid.innerHTML = `
                <div class="stat-card"><div class="stat-number">${completedRacesThiago + completedRacesThamis}</div><div class="stat-label">Corridas Conclu√≠das (Total)</div></div>
                <div class="stat-card"><div class="stat-number">${totalRacesJuntos} üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª</div><div class="stat-label">Corridas Juntos</div></div>
                <div class="stat-card"><div class="stat-number">${(totalKmThiago + totalKmThamis).toFixed(1)} km</div><div class="stat-label">Total KM (Casal)</div></div>
                <div class="stat-card">
                    <div class="stat-number">
                        <span class="runner-pr-thiago">${totalKmThiago.toFixed(1)}</span> / <strong class="runner-pr-thamis">${totalKmThamis.toFixed(1)}</strong>
                    </div>
                    <div class="stat-label">Total KM (${RUNNER_1_CONFIG.nameShort} / ${RUNNER_2_CONFIG.nameShort})</div>
                </div>`;
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';

            // Converter o objeto de corridas em um array e ordenar
            const sortedRaces = Object.entries(db.races)
                .map(([id, race]) => ({ ...race, id: id })) // Adiciona o ID do Firebase ao objeto
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const racesByYear = sortedRaces.reduce((acc, race) => {
                const year = race.year || new Date(race.date + 'T00:00:00').getFullYear().toString();
                if (!acc[year]) acc[year] = [];
                acc[year].push(race);
                return acc;
            }, {});

            const sortedYears = Object.keys(racesByYear).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                container.innerHTML = '<div class="loader">Nenhuma corrida encontrada. Clique em "Adicionar Nova Corrida" para come√ßar.</div>';
                return;
            }

            for (const year of sortedYears) {
                const yearGroup = document.createElement('div');
                yearGroup.className = 'year-group';
                const yearEmoji = year.split('').map(d => ['0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£'][d]).join('');
                yearGroup.innerHTML = `<h2 class="year-title">${yearEmoji} (${racesByYear[year].length} provas)</h2>`;

                const raceList = document.createElement('div');
                raceList.className = 'race-card-list';
                racesByYear[year].forEach(race => raceList.appendChild(createRaceCard(race)));

                yearGroup.appendChild(raceList);
                container.appendChild(yearGroup);
            }
        }

        function createRaceCard(race) {
            const card = document.createElement('div');
            let cardStatus = 'completed';
            if (race.thiago.status === 'planned' || race.thamis.status === 'planned') cardStatus = 'planned';
            if (race.thiago.status === 'skipped' && race.thamis.status === 'skipped') cardStatus = 'skipped';

            card.className = `race-card status-${cardStatus}`;
            card.dataset.id = race.id; // Armazena o ID do Firebase

            const thiagoDist = race.thiago.distance || race.distance;
            const thamisDist = race.thamis.distance || race.distance;

            const thiagoPace = calculatePace(race.thiago.status === 'completed' ? race.thiago.time : race.thiago.goalTime, thiagoDist);
            const thamisPace = calculatePace(race.thamis.status === 'completed' ? race.thamis.time : race.thamis.goalTime, thamisDist);

            let raceDistDisplay = '';
            if (race.distance) raceDistDisplay = `${race.distance}km`;
            else if (thiagoDist && thamisDist && thiagoDist !== thamisDist) raceDistDisplay = `${thiagoDist || '?'}k / ${thamisDist || '?'}k`;
            else raceDistDisplay = `${thiagoDist || thamisDist || '?'}km`;

            card.innerHTML = `
                <div class="race-card-header">
                    <h3>${race.raceName}</h3>
                    <span class="date">${new Date(race.date).toLocaleDateString('pt-BR', {timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric'})}</span>
                </div>
                <div class="race-card-body">
                    ${createRunnerInfoHTML(RUNNER_1_CONFIG, race.thiago, thiagoDist, thiagoPace)}
                    ${createRunnerInfoHTML(RUNNER_2_CONFIG, race.thamis, thamisDist, thamisPace)}
                </div>
                <div class="race-card-footer">
                    <div>
                        <span class="juntos-icon">${race.juntos ? 'üë©üèª‚Äç‚ù§Ô∏è‚Äçüë®üèª' : ''}</span>
                        <span class="race-notes">${race.notes || ''}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="race-distance">${raceDistDisplay}</span>
                        <div class="race-controls">
                            <button class="btn-control btn-edit" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-control btn-delete" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;

            card.querySelector('.btn-edit').addEventListener('click', () => openModal(race.id));
            card.querySelector('.btn-delete').addEventListener('click', () => deleteRace(race.id));
            return card;
        }

        function createRunnerInfoHTML(config, runnerData, distance, pace) {
            let timeHTML = '', paceHTML = '';
            switch (runnerData.status) {
                case 'completed':
                    timeHTML = `<div class="runner-time">${secondsToTime(timeToSeconds(runnerData.time))}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace">${pace}</div>`;
                    break;
                case 'planned':
                    const goalTime = runnerData.goalTime || (runnerData.time && runnerData.time.includes(':') ? runnerData.time : null);
                    timeHTML = `<div class="runner-time goal">‚è≥ ${goalTime ? secondsToTime(timeToSeconds(goalTime)) : 'Planejada'}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace goal">(Meta: ${pace})</div>`;
                    break;
                case 'skipped':
                    timeHTML = `<div class="runner-time skipped">‚ùå N√£o correu</div>`;
                    break;
                default: timeHTML = `<div class="runner-time skipped">N/A</div>`;
            }

            if (runnerData.status === 'skipped') {
                return `<div class="runner-info"><span class="runner-name ${config.class}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}</div></div>`;
            }
            return `<div class="runner-info"><span class="runner-name ${config.class}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}${paceHTML}</div></div>`;
        }

        // --- Fun√ß√µes do Modal e Formul√°rio ---
        const modal = document.getElementById('race-modal');
        const form = document.getElementById('race-form');
        const modalTitle = document.getElementById('modal-title');
        const btnDelete = document.getElementById('btn-delete');

        function openModal(raceId = null) {
            form.reset();
            document.getElementById('race-id').value = '';
            btnDelete.classList.add('hidden');

            if (raceId) {
                modalTitle.textContent = 'Editar Corrida';
                btnDelete.classList.remove('hidden');
                const race = db.races[raceId];
                if (!race) return;

                document.getElementById('race-id').value = raceId;
                document.getElementById('raceName').value = race.raceName;
                document.getElementById('raceDate').value = race.date;
                document.getElementById('raceDistance').value = race.distance;
                document.getElementById('raceJuntos').checked = race.juntos;
                document.getElementById('raceNotes').value = race.notes || '';

                document.getElementById('thiagoStatus').value = race.thiago.status || 'skipped';
                const thiagoTime = race.thiago.status === 'completed' ? race.thiago.time : (race.thiago.goalTime || race.thiago.time || '');
                document.getElementById('thiagoTime').value = normalizeTime(thiagoTime) ? secondsToTime(timeToSeconds(thiagoTime)) : '';
                document.getElementById('thiagoDistance').value = race.thiago.distance || '';

                document.getElementById('thamisStatus').value = race.thamis.status || 'skipped';
                const thamisTime = race.thamis.status === 'completed' ? race.thamis.time : (race.thamis.goalTime || race.thamis.time || '');
                document.getElementById('thamisTime').value = normalizeTime(thamisTime) ? secondsToTime(timeToSeconds(thamisTime)) : '';
                document.getElementById('thamisDistance').value = race.thamis.distance || '';
            } else {
                modalTitle.textContent = 'Adicionar Nova Corrida';
                document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
            }
            modal.showModal();
        }

        function closeModal() { modal.close(); }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('race-id').value;
            const date = document.getElementById('raceDate').value;
            const thiagoTimeRaw = document.getElementById('thiagoTime').value;
            const thamisTimeRaw = document.getElementById('thamisTime').value;
            const thiagoStatus = document.getElementById('thiagoStatus').value;
            const thamisStatus = document.getElementById('thamisStatus').value;

            const raceData = {
                date: date,
                year: new Date(date + 'T00:00:00').getFullYear().toString(),
                raceName: document.getElementById('raceName').value,
                distance: parseFloat(document.getElementById('raceDistance').value) || null,
                juntos: document.getElementById('raceJuntos').checked,
                notes: document.getElementById('raceNotes').value || null,
                thiago: {
                    status: thiagoStatus,
                    time: thiagoStatus === 'completed' ? normalizeTime(thiagoTimeRaw) : null,
                    goalTime: thiagoStatus === 'planned' ? normalizeTime(thiagoTimeRaw) : null,
                    distance: parseFloat(document.getElementById('thiagoDistance').value) || null
                },
                thamis: {
                    status: thamisStatus,
                    time: thamisStatus === 'completed' ? normalizeTime(thamisTimeRaw) : null,
                    goalTime: thamisStatus === 'planned' ? normalizeTime(thamisTimeRaw) : null,
                    distance: parseFloat(document.getElementById('thamisDistance').value) || null
                }
            };

            if (id) {
                // Atualiza
                const raceRef = firebase.database().ref(racesRef).child(id);
                raceRef.set(raceData)
                    .then(closeModal)
                    .catch(err => console.error(err));
            } else {
                // Cria
                firebase.database().ref(racesRef).push(raceData)
                    .then(closeModal)
                    .catch(err => console.error(err));
            }
        }

        function deleteRace(raceId) {
            const race = db.races[raceId];
            if (!confirm(`Tem certeza que deseja excluir esta corrida?\n\n${race.raceName} (${race.date})`)) return;

            firebase.database().ref(racesRef).child(raceId).remove()
                .then(closeModal)
                .catch(err => console.error(err));
        }

        function renderAll() {
            updateProfileUI(); // Atualiza nomes
            renderDashboard();
            renderHistory();
        }

        // --- Inicializa√ß√£o e Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // VERIFICA√á√ÉO CR√çTICA
            if (!firebaseConfig.apiKey) {
                alert("ERRO DE CONFIGURA√á√ÉO: O objeto firebaseConfig est√° vazio. Voc√™ colou suas chaves do Firebase na Fase 2?");
                document.getElementById('history-container').innerHTML = '<div class="loader" style="color: #f44336;">ERRO: O Firebase n√£o foi configurado. Cole seu `firebaseConfig` no arquivo index.html.</div>';
                return;
            }

            // Inicializa o Firebase
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();

            // Define os "caminhos" no banco de dados
            // NOTA: Para V3, estamos simplificando. A V4 (multi-usu√°rio) exigiria um ID de usu√°rio aqui.
            racesRef = 'races'; 
            profileRef = 'profile';

            // Escuta por mudan√ßas no Perfil
            firebase.database().ref(profileRef).on('value', (snapshot) => {
                const profileData = snapshot.val();
                if (profileData) {
                    db.profile = profileData;
                }
                // Se n√£o houver perfil, ele usar√° os padr√µes e criar√° um
                // (L√≥gica de cria√ß√£o de perfil inicial omitida para simplicidade de V3)

                // Escuta por mudan√ßas nas Corridas
                firebase.database().ref(racesRef).on('value', (snapshot) => {
                    db.races = snapshot.val() || {};
                    renderAll(); // Renderiza tudo com os novos dados
                });
            });

            // Listeners do Modal
            document.getElementById('btn-add-new').addEventListener('click', () => openModal());
            document.getElementById('btn-close-modal').addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
            document.getElementById('btn-cancel').addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
            form.addEventListener('submit', handleFormSubmit);
            btnDelete.addEventListener('click', () => {
                const id = document.getElementById('race-id').value;
                if(id) deleteRace(id);
            });
        });

    </script>
</body>
</html>
