<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currículo de Corredores - thIAguinho Soluções</title>
    <style>
        /* ================================================= */
        /* ESTILIZAÇÃO GERAL (DARK MODE)                     */
        /* ================================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1f2027 0%, #3a3a52 100%);
            min-height: 100vh;
            padding: 20px;
            color: #f0f0f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(42, 42, 58, 0.85);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
        }

        .header {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        /* ================================================= */
        /* AUTENTICAÇÃO E CONTROLES DE CONTA                 */
        /* ================================================= */
        
        .auth-controls {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .auth-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        #user-info {
            font-size: 0.9em;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #user-info img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .hidden {
            display: none !important;
        }
        
        /* ================================================= */
        /* TELA DE LOGIN (EMAIL/SENHA)                       */
        /* ================================================= */
        #login-view {
            padding: 40px 30px;
            background: #1a1a2e;
            text-align: center;
        }

        #login-view h2 {
            color: #c5cae9;
            margin-bottom: 20px;
        }
        
        #login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        #login-form input {
            padding: 12px 15px;
            border: 2px solid #555;
            border-radius: 10px;
            font-size: 1em;
            background: #333345;
            color: #f0f0f0;
        }
        
        #login-form input:focus {
             outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        #login-error {
            color: #f44336;
            font-weight: 600;
            margin-top: 10px;
        }

        /* ================================================= */
        /* SELETOR DE PERFIL PÚBLICO                         */
        /* ================================================= */
        
        #public-view {
            padding: 30px;
            text-align: center;
            background: #1a1a2e;
        }
        
        #public-view h2 {
            color: #c5cae9;
            margin-bottom: 20px;
        }
        
        .profile-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .profile-card {
            background: #2a2a3a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            text-align: left;
        }
        
        .profile-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }
        
        .profile-card h3 {
            color: #4dabf5;
            margin-bottom: 5px;
        }
        .profile-card h3.runner2-name {
            color: #f06292;
        }
        .profile-card p {
            font-size: 0.9em;
            color: #b0b0b0;
        }


        /* ================================================= */
        /* DASHBOARD DE PERFORMANCE (STATS)                  */
        /* ================================================= */
        .dashboard-section {
            padding: 30px;
            background: rgba(20, 20, 30, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #c5cae9;
        }

        .dashboard-subheader {
            text-align: center;
            margin-bottom: 15px;
            color: #aaa;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2a2a3a;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #c5cae9;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-label {
            color: #b0b0b0;
            font-weight: 600;
            font-size: 0.9em;
        }

        .pr-card .stat-number {
            font-size: 1.4em;
        }

        .pr-card .runner-pr {
            font-size: 0.9em;
            color: #f0f0f0;
            line-height: 1.5;
        }

        .runner-pr-thiago {
            color: #4dabf5;
            font-weight: 600;
        }

        .runner-pr-thamis {
            color: #f06292;
            font-weight: 600;
        }

        /* ================================================= */
        /* CONTROLES E HISTÓRICO                             */
        /* ================================================= */
        .controls-section {
            padding: 20px 30px;
            text-align: center;
            background: #1a1a2e;
        }

        .btn-add {
            padding: 15px 30px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .history-section {
            padding: 30px;
            background: transparent;
        }

        .year-group {
            margin-bottom: 30px;
        }

        .year-title {
            font-size: 2em;
            color: #c5cae9;
            border-bottom: 3px solid #c5cae9;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .race-card-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .race-card {
            background: #2a2a3a;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .race-card.status-planned {
            background: #3a382a;
            border: 2px dashed #ffc107;
        }

        .race-card.status-skipped {
            background: #3a2a2a;
            opacity: 0.7;
        }

        .race-card-header {
            padding: 20px;
            border-bottom: 1px solid #444;
        }

        .race-card-header h3 {
            font-size: 1.3em;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .race-card-header .date {
            font-size: 0.9em;
            color: #b0b0b0;
            font-weight: 600;
        }

        .race-card-body {
            padding: 20px;
            flex-grow: 1;
        }

        .runner-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #444;
        }

        .runner-info:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: 0;
        }

        .runner-info .runner-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .runner-name.runner1 {
            color: #4dabf5;
        }

        .runner-name.runner2 {
            color: #f06292;
        }

        .runner-details {
            text-align: right;
        }

        .runner-time {
            font-size: 1.2em;
            font-weight: 700;
            color: #4caf50;
        }

        .runner-time.goal {
            color: #ffc107;
            font-size: 1.1em;
        }

        .runner-time.skipped {
            color: #f44336;
            font-size: 1.1em;
            font-style: italic;
        }

        .runner-pace {
            font-size: 0.9em;
            color: #b0b0b0;
            font-family: monospace;
        }

        .runner-pace.goal {
            color: #ffeb3b;
        }

        .race-card-footer {
            padding: 10px 20px;
            background: #222230;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .juntos-icon {
            font-size: 1.5em;
        }

        .race-notes {
            font-size: 0.85em;
            color: #b0b0b0;
            font-style: italic;
            margin-left: 10px;
        }

        .race-distance {
            font-size: 1.1em;
            font-weight: bold;
            color: #c5cae9;
            margin-right: 15px;
        }

        .race-controls {
            display: flex;
            gap: 10px;
        }

        .btn-control {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #b0b0b0;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .btn-control:hover {
            opacity: 1;
        }

        /* ================================================= */
        /* MODAL E FORMULÁRIO (DARK)                         */
        /* ================================================= */
        dialog {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            padding: 0;
            overflow: hidden;
            background: #2a2a3a;
            color: #f0f0f0;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-header {
            padding: 20px 30px;
            background: #1f2027;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #c5cae9;
        }

        .modal-body {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            color: #b0b0b0;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #555;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #333345;
            color: #f0f0f0;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .form-group.checkbox {
            grid-column: 1 / -1;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .form-group.checkbox input {
            width: 20px;
            height: 20px;
        }

        .runner-form-group {
            border: 2px solid #555;
            border-radius: 10px;
            padding: 15px;
        }

        .runner-form-group h4 {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        .runner-form-group.runner1 h4 {
            color: #4dabf5;
        }

        .runner-form-group.runner2 h4 {
            color: #f06292;
        }

        .runner-form-group .form-group {
            margin-bottom: 10px;
        }

        .runner-form-group .form-group:last-child {
            margin-bottom: 0;
        }


        .modal-footer {
            padding: 20px 30px;
            background: #1f2027;
            border-top: 1px solid #444;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        #btn-delete {
            background: #dc3545;
            color: white;
            margin-right: auto;
        }

        #btn-delete:hover {
            background: #c82333;
        }

        #btn-delete.hidden {
            display: none;
        }

        .footer {
            background: #1f2027;
            color: #aaa;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            border-top: 1px solid #444;
        }

        /* Animação de Loading Simples */
        .loader {
            padding: 40px;
            text-align: center;
            font-size: 1.2em;
            color: #c5cae9;
            font-weight: 600;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .auth-controls {
                position: static;
                justify-content: center;
                padding-bottom: 15px;
                flex-wrap: wrap;
            }
            
            #login-form {
                max-width: 100%;
            }

            .header h1 { font-size: 2em; }
            .header p { font-size: 1em; }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .race-card-list {
                grid-template-columns: 1fr;
            }

            .modal-body {
                grid-template-columns: 1fr;
            }

            .form-group.checkbox {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="auth-controls">
                <div id="user-info" class="hidden">
                    <span id="user-email"></span>
                </div>
                <button class="auth-btn hidden" id="btn-logout">Logout</button>
            </div>
            
            <h1>Currículo Esportivo 🏃‍♂️🏃‍♀️</h1>
            <p id="header-subtitle">Carregando...</p>
        </div>

        <div id="login-or-public-view">
            
            <div id="login-view" class="hidden">
                <h2>Acessar Meu Currículo</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="E-mail" required>
                    <input type="password" id="login-password" placeholder="Senha" required>
                    <button type="submit" class="auth-btn btn-primary" id="btn-login-submit">Entrar</button>
                    <div id="login-error" class="hidden"></div>
                </form>
            </div>

            <div id="public-view" class="hidden">
                <h2>Currículos Públicos</h2>
                <div class="profile-list" id="public-profile-list">
                    <div class="loader">Carregando perfis públicos...</div>
                </div>
            </div>
        </div>

        <div id="user-content" class="hidden">
            <div class="dashboard-section">
                <h2 class="dashboard-header">Dashboard de Performance</h2>
                <h3 class="dashboard-subheader">Recordes Pessoais (PRs)</h3>
                <div class="stats-grid" id="pr-grid">
                    <div class="loader">Carregando PRs...</div>
                </div>
                <h3 class="dashboard-subheader" style="margin-top: 30px;">Estatísticas Gerais</h3>
                <div class="stats-grid" id="summary-grid">
                    <div class="loader">Calculando...</div>
                </div>
            </div>

            <div class="controls-section hidden" id="controls-section">
                <button class="btn-add" id="btn-add-new">➕ Adicionar Nova Corrida</button>
            </div>

            <div class="history-section">
                <div id="history-container">
                    <div class="loader">Carregando histórico do Firebase...</div>
                </div>
            </div>
        </div>

        <div class="footer">
            Desenvolvido com 🤖 por <strong>thIAguinho Soluções</strong>
        </div>
    </div>

    <dialog id="race-modal">
        <form id="race-form">
            <input type="hidden" id="race-id">
            <div class="modal-header">
                <h2 id="modal-title">Adicionar Nova Corrida</h2>
                <button type="button" class="btn-control" id="btn-close-modal" aria-label="Fechar">✖️</button>
            </div>

            <div class="modal-body">
                <div class="form-group full-width">
                    <label for="raceName">Nome da Corrida</label>
                    <input type="text" id="raceName" required>
                </div>
                <div class="form-group">
                    <label for="raceDate">Data</label>
                    <input type="date" id="raceDate" required>
                </div>
                <div class="form-group">
                    <label for="raceDistance">Distância Padrão (km)</label>
                    <input type="number" step="0.1" id="raceDistance" placeholder="Ex: 5 (Deixe em branco se for misto)">
                </div>

                <div class="runner-form-group runner1" id="runner1-form-group">
                    <h4 id="runner1-form-name">Corredor 1 🏃‍♂️</h4>
                    <div class="form-group">
                        <label for="runner1Status">Status</label>
                        <select id="runner1Status">
                            <option value="completed">Completou ✅</option>
                            <option value="planned">Planejada ⏳</option>
                            <option value="skipped">Não Correu ❌</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="runner1Time">Tempo (HH:MM:SS)</label>
                        <input type="text" id="runner1Time" placeholder="00:29:10">
                    </div>
                    <div class="form-group">
                        <label for="runner1Distance">Distância (se diferente da padrão)</label>
                        <input type="number" step="0.1" id="runner1Distance" placeholder="Ex: 10">
                    </div>
                </div>

                <div class="runner-form-group runner2" id="runner2-form-group">
                    <h4 id="runner2-form-name">Corredor 2 🏃‍♀️</h4>
                    <div class="form-group">
                        <label for="runner2Status">Status</label>
                        <select id="runner2Status">
                            <option value="completed">Completou ✅</option>
                            <option value="planned">Planejada ⏳</option>
                            <option value="skipped">Não Correu ❌</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="runner2Time">Tempo (HH:MM:SS)</label>
                        <input type="text" id="runner2Time" placeholder="00:40:36">
                    </div>
                    <div class="form-group">
                        <label for="runner2Distance">Distância (se diferente da padrão)</label>
                        <input type="number" step="0.1" id="runner2Distance" placeholder="Ex: 5">
                    </div>
                </div>

                <div class="form-group checkbox">
                    <input type="checkbox" id="raceJuntos">
                    <label for="raceJuntos">Correram Juntos? 👩🏻‍❤️‍👨🏻</label>
                </div>

                <div class="form-group full-width">
                    <label for="raceNotes">Notas</label>
                    <input type="text" id="raceNotes" placeholder="Ex: Corrida com ♿, meta de tempo...">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn" id="btn-delete" class="hidden">Excluir</button>
                <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="btn-save">Salvar</button>
            </div>
        </form>
    </dialog>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // =================================================================
        // ARQUITETURA V3.1 - INICIALIZAÇÃO DO FIREBASE (COM SUAS CHAVES)
        // =================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyAyMTzM7sem903SLJsmBeMF3XyvaeGv7Hg",
          authDomain: "curriculo-corridas-7cd4e.firebaseapp.com",
          databaseURL: "https://curriculo-corridas-7cd4e-default-rtdb.firebaseio.com",
          projectId: "curriculo-corridas-7cd4e",
          storageBucket: "curriculo-corridas-7cd4e.firebasestorage.app",
          messagingSenderId: "126737528447",
          appId: "1:126737528447:web:3d316262e3d2df9dc0f14a"
        };
        
        // =================================================================
        // ARQUITETURA V3.1 - LÓGICA DA APLICAÇÃO (EMAIL/SENHA + RTDB)
        // =================================================================

        // --- Variáveis Globais do App ---
        let db = {
            races: {},
            profile: {}
        };
        
        let firebaseApp, database, auth;
        let authUser = null; // Armazena o usuário logado
        let currentViewingUid = null; // UID do perfil sendo visualizado
        let isAdmin = false; // Flag de Admin
        
        // CORREÇÃO: Chaves de dados estáticas para corresponder ao seu JSON
        const RUNNER_1_KEY = "runner1";
        const RUNNER_2_KEY = "runner2";
        
        // Configuração de perfil padrão (será sobreposta pelo Firebase)
        let RUNNER_1_PROFILE = { name: 'Corredor 1', nameShort: 'Corredor 1', emoji: '🏃‍♂️' };
        let RUNNER_2_PROFILE = { name: 'Corredora 2', nameShort: 'Corredora 2', emoji: '🏃‍♀️' };
        
        // --- Cache de Elementos DOM ---
        const dom = {
            btnLogout: document.getElementById('btn-logout'),
            userInfo: document.getElementById('user-info'),
            userEmail: document.getElementById('user-email'),
            loginOrPublicView: document.getElementById('login-or-public-view'),
            loginView: document.getElementById('login-view'),
            loginForm: document.getElementById('login-form'),
            loginEmail: document.getElementById('login-email'),
            loginPassword: document.getElementById('login-password'),
            loginError: document.getElementById('login-error'),
            publicView: document.getElementById('public-view'),
            publicProfileList: document.getElementById('public-profile-list'),
            userContent: document.getElementById('user-content'),
            headerSubtitle: document.getElementById('header-subtitle'),
            prGrid: document.getElementById('pr-grid'),
            summaryGrid: document.getElementById('summary-grid'),
            controlsSection: document.getElementById('controls-section'),
            btnAddnew: document.getElementById('btn-add-new'),
            historyContainer: document.getElementById('history-container'),
            modal: document.getElementById('race-modal'),
            form: document.getElementById('race-form'),
            modalTitle: document.getElementById('modal-title'),
            btnDelete: document.getElementById('btn-delete'),
            btnCloseModal: document.getElementById('btn-close-modal'),
            btnCancel: document.getElementById('btn-cancel'),
            runner1FormGroup: document.getElementById('runner1-form-group'),
            runner2FormGroup: document.getElementById('runner2-form-group')
        };

        // --- Funções Utilitárias de Tempo e Pace ---
        function timeToSeconds(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return null;
            const parts = timeStr.split(':').map(Number).filter(n => !isNaN(n));
            let seconds = 0;
            if (parts.length === 2) { seconds = parts[0] * 60 + parts[1]; }
            else if (parts.length === 3) { seconds = parts[0] * 3600 + parts[1] * 60 + parts[2]; }
            else { return null; }
            return seconds;
        }

        function secondsToTime(totalSeconds) {
            if (totalSeconds === null || isNaN(totalSeconds) || totalSeconds === Infinity) return 'N/A';
            totalSeconds = Math.round(totalSeconds);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return (hours > 0) ? `${pad(hours)}:${pad(minutes)}:${pad(seconds)}` : `${pad(minutes)}:${pad(seconds)}`;
        }

        function normalizeTime(timeStr) {
            if (!timeStr) return null;
            const cleanTime = timeStr.replace(/[^0-9:]/g, '');
            const parts = cleanTime.split(':');
            if (parts.length === 2) { return `00:${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}`; }
            else if (parts.length === 3) { return `${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}:${String(parts[2]).padStart(2, '0')}`; }
            return null;
        }

        function calculatePace(timeStr, distance) {
            const seconds = timeToSeconds(timeStr);
            const dist = parseFloat(distance);
            if (!seconds || !dist || dist <= 0) return 'N/A';
            const paceInSeconds = seconds / dist;
            const paceMinutes = Math.floor(paceInSeconds / 60);
            const paceSeconds = Math.round(paceInSeconds % 60);
            return `${String(paceMinutes).padStart(2, '0')}:${String(paceSeconds).padStart(2, '0')} /km`;
        }

        // --- Funções de Lógica da Aplicação ---

        /**
         * Atualiza a UI com base no perfil carregado (do db.profile)
         */
        function updateProfileUI() {
            const profile = db.profile;
            if (profile && profile.runner1Name && profile.runner2Name) {
                // Carrega os nomes do perfil do banco de dados
                RUNNER_1_PROFILE = { name: profile.runner1Name, nameShort: profile.runner1Name.split(' ')[0], emoji: '🏃‍♂️' };
                RUNNER_2_PROFILE = { name: profile.runner2Name, nameShort: profile.runner2Name.split(' ')[0], emoji: '🏃‍♀️' };
            }

            dom.headerSubtitle.textContent = `${RUNNER_1_PROFILE.name} & ${RUNNER_2_PROFILE.name}`;
            dom.runner1FormGroup.querySelector('h4').innerHTML = `${RUNNER_1_PROFILE.name} ${RUNNER_1_PROFILE.emoji}`;
            dom.runner2FormGroup.querySelector('h4').innerHTML = `${RUNNER_2_PROFILE.name} ${RUNNER_2_PROFILE.emoji}`;
        }

        /**
         * Renderiza o Dashboard (PRs e Estatísticas)
         */
        function renderDashboard() {
            const racesArray = Object.values(db.races);
            const prs = { runner1: {}, runner2: {} };
            // Distâncias Padrão para PRs
            const distances = [2, 5, 6, 7, 10, 12, 16, 17]; 
            
            let totalKmRunner1 = 0, totalKmRunner2 = 0, totalRacesJuntos = 0, completedRacesRunner1 = 0, completedRacesRunner2 = 0;

            distances.forEach(d => {
                prs.runner1[d] = { time: 'N/A', seconds: Infinity };
                prs.runner2[d] = { time: 'N/A', seconds: Infinity };
            });

            racesArray.forEach(race => {
                // CORREÇÃO: Usa as chaves estáticas 'runner1' e 'runner2'
                const runner1Data = race.runner1; 
                const runner2Data = race.runner2;
                
                if(!runner1Data || !runner2Data) return; 

                if(race.juntos && runner1Data.status === 'completed' && runner2Data.status === 'completed') totalRacesJuntos++;

                if (runner1Data.status === 'completed') {
                    completedRacesRunner1++;
                    const dist = runner1Data.distance || race.distance;
                    const timeSec = timeToSeconds(runner1Data.time);
                    if (dist) totalKmRunner1 += dist;
                    if (prs.runner1[dist] && timeSec < prs.runner1[dist].seconds) {
                        prs.runner1[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }

                if (runner2Data.status === 'completed') {
                    completedRacesRunner2++;
                    const dist = runner2Data.distance || race.distance;
                    const timeSec = timeToSeconds(runner2Data.time);
                    if (dist) totalKmRunner2 += dist;
                    if (prs.runner2[dist] && timeSec < prs.runner2[dist].seconds) {
                        prs.runner2[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
            });

            dom.prGrid.innerHTML = distances.map(d => `
                <div class="stat-card pr-card">
                    <div class="stat-label">PR ${d}km</div>
                    <div class="stat-number">
                        <div class="runner-pr"><span class="runner-pr-thiago">${RUNNER_1_PROFILE.nameShort}: ${prs.runner1[d].time}</span></div>
                        <div class="runner-pr"><strong class="runner-pr-thamis">${RUNNER_2_PROFILE.nameShort}: ${prs.runner2[d].time}</strong></div>
                    </div>
                </div>`).join('');

            dom.summaryGrid.innerHTML = `
                <div class="stat-card"><div class="stat-number">${completedRacesRunner1 + completedRacesRunner2}</div><div class="stat-label">Corridas Concluídas (Total)</div></div>
                <div class="stat-card"><div class="stat-number">${totalRacesJuntos} 👩🏻‍❤️‍👨🏻</div><div class="stat-label">Corridas Juntos</div></div>
                <div class="stat-card"><div class="stat-number">${(totalKmRunner1 + totalKmRunner2).toFixed(1)} km</div><div class="stat-label">Total KM (Casal)</div></div>
                <div class="stat-card">
                    <div class="stat-number">
                        <span class="runner-pr-thiago">${totalKmRunner1.toFixed(1)}</span> / <strong class="runner-pr-thamis">${totalKmRunner2.toFixed(1)}</strong>
                    </div>
                    <div class="stat-label">Total KM (${RUNNER_1_PROFILE.nameShort} / ${RUNNER_2_PROFILE.nameShort})</div>
                </div>`;
        }

        /**
         * Renderiza o Histórico de Corridas
         */
        function renderHistory() {
            dom.historyContainer.innerHTML = '';
            const sortedRaces = Object.entries(db.races)
                .map(([id, race]) => ({ ...race, id: id }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const racesByYear = sortedRaces.reduce((acc, race) => {
                const year = race.year || new Date(race.date + 'T00:00:00').getFullYear().toString();
                if (!acc[year]) acc[year] = [];
                acc[year].push(race);
                return acc;
            }, {});

            const sortedYears = Object.keys(racesByYear).sort((a, b) => b - a);

            if (sortedYears.length === 0) {
                dom.historyContainer.innerHTML = `<div class="loader">${authUser ? 'Nenhuma corrida encontrada. Clique em "Adicionar Nova Corrida".' : 'Perfil sem corridas.'}</div>`;
                return;
            }

            for (const year of sortedYears) {
                const yearGroup = document.createElement('div');
                yearGroup.className = 'year-group';
                const yearEmoji = year.split('').map(d => ['0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣'][d]).join('');
                yearGroup.innerHTML = `<h2 class="year-title">${yearEmoji} (${racesByYear[year].length} provas)</h2>`;

                const raceList = document.createElement('div');
                raceList.className = 'race-card-list';
                racesByYear[year].forEach(race => raceList.appendChild(createRaceCard(race)));

                yearGroup.appendChild(raceList);
                dom.historyContainer.appendChild(yearGroup);
            }
        }

        /**
         * Cria o HTML para um único card de corrida
         */
        function createRaceCard(race) {
            const card = document.createElement('div');
            // CORREÇÃO: Usa as chaves estáticas 'runner1' e 'runner2'
            const runner1Data = race.runner1;
            const runner2Data = race.runner2;
            
            if (!runner1Data || !runner2Data) {
                console.warn("Dados da corrida incompletos:", race);
                return card; 
            }

            let cardStatus = 'completed';
            if (runner1Data.status === 'planned' || runner2Data.status === 'planned') cardStatus = 'planned';
            if (runner1Data.status === 'skipped' && runner2Data.status === 'skipped') cardStatus = 'skipped';

            card.className = `race-card status-${cardStatus}`;
            card.dataset.id = race.id;

            const runner1Dist = runner1Data.distance || race.distance;
            const runner2Dist = runner2Data.distance || race.distance;

            const runner1Pace = calculatePace(runner1Data.status === 'completed' ? runner1Data.time : runner1Data.goalTime, runner1Dist);
            const runner2Pace = calculatePace(runner2Data.status === 'completed' ? runner2Data.time : runner2Data.goalTime, runner2Dist);

            let raceDistDisplay = '';
            if (race.distance) raceDistDisplay = `${race.distance}km`;
            else if (runner1Dist && runner2Dist && runner1Dist !== runner2Dist) raceDistDisplay = `${runner1Dist || '?'}k / ${runner2Dist || '?'}k`;
            else raceDistDisplay = `${runner1Dist || runner2Dist || '?'}km`;

            const canEdit = authUser && authUser.uid === currentViewingUid;

            card.innerHTML = `
                <div class="race-card-header">
                    <h3>${race.raceName}</h3>
                    <span class="date">${new Date(race.date).toLocaleDateString('pt-BR', {timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric'})}</span>
                </div>
                <div class="race-card-body">
                    ${createRunnerInfoHTML(RUNNER_1_PROFILE, runner1Data, runner1Dist, runner1Pace, 'runner1')}
                    ${createRunnerInfoHTML(RUNNER_2_PROFILE, runner2Data, runner2Dist, runner2Pace, 'runner2')}
                </div>
                <div class="race-card-footer">
                    <div>
                        <span class="juntos-icon">${race.juntos ? '👩🏻‍❤️‍👨🏻' : ''}</span>
                        <span class="race-notes">${race.notes || ''}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span class="race-distance">${raceDistDisplay}</span>
                        <div class="race-controls ${canEdit ? '' : 'hidden'}">
                            <button class="btn-control btn-edit" title="Editar">✏️</button>
                            <button class="btn-control btn-delete" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>`;
            
            if(canEdit) {
                card.querySelector('.btn-edit').addEventListener('click', () => openModal(race.id));
                card.querySelector('.btn-delete').addEventListener('click', () => deleteRace(race.id));
            }

            return card;
        }

        /**
         * Cria o HTML para a info de CADA corredor dentro do card
         */
        function createRunnerInfoHTML(config, runnerData, distance, pace, cssClass) {
            let timeHTML = '', paceHTML = '';
            switch (runnerData.status) {
                case 'completed':
                    timeHTML = `<div class="runner-time">${secondsToTime(timeToSeconds(runnerData.time))}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace">${pace}</div>`;
                    break;
                case 'planned':
                    const goalTime = runnerData.goalTime || (runnerData.time && runnerData.time.includes(':') ? runnerData.time : null);
                    timeHTML = `<div class="runner-time goal">⏳ ${goalTime ? secondsToTime(timeToSeconds(goalTime)) : 'Planejada'}</div>`;
                    if (pace !== 'N/A') paceHTML = `<div class="runner-pace goal">(Meta: ${pace})</div>`;
                    break;
                case 'skipped':
                    timeHTML = `<div class="runner-time skipped">❌ Não correu</div>`;
                    break;
                default: timeHTML = `<div class="runner-time skipped">N/A</div>`;
            }

            // CORREÇÃO: usa 'runner1' e 'runner2' para as classes de cor
            if (runnerData.status === 'skipped') {
                return `<div class="runner-info"><span class="runner-name ${cssClass}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}</div></div>`;
            }
            return `<div class="runner-info"><span class="runner-name ${cssClass}">${config.name} ${config.emoji}</span><div class="runner-details">${timeHTML}${paceHTML}</div></div>`;
        }
        
        // --- Funções do Modal e CRUD ---
        
        function openModal(raceId = null) {
            dom.form.reset();
            document.getElementById('race-id').value = '';
            dom.btnDelete.classList.add('hidden');
            
            // Garante que os nomes no formulário são os do usuário logado
            dom.runner1FormGroup.querySelector('h4').innerHTML = `${RUNNER_1_PROFILE.name} ${RUNNER_1_PROFILE.emoji}`;
            dom.runner2FormGroup.querySelector('h4').innerHTML = `${RUNNER_2_PROFILE.name} ${RUNNER_2_PROFILE.emoji}`;

            if (raceId) {
                // Modo Edição
                dom.modalTitle.textContent = 'Editar Corrida';
                dom.btnDelete.classList.remove('hidden');
                const race = db.races[raceId];
                if (!race) return;

                document.getElementById('race-id').value = raceId;
                document.getElementById('raceName').value = race.raceName;
                document.getElementById('raceDate').value = race.date;
                document.getElementById('raceDistance').value = race.distance;
                document.getElementById('raceJuntos').checked = race.juntos;
                document.getElementById('raceNotes').value = race.notes || '';

                // CORREÇÃO: Usa as chaves estáticas 'runner1' e 'runner2'
                const runner1Data = race.runner1;
                const runner2Data = race.runner2;

                document.getElementById('runner1Status').value = runner1Data.status || 'skipped';
                const runner1Time = runner1Data.status === 'completed' ? runner1Data.time : (runner1Data.goalTime || runner1Data.time || '');
                document.getElementById('runner1Time').value = normalizeTime(runner1Time) ? secondsToTime(timeToSeconds(runner1Time)) : '';
                document.getElementById('runner1Distance').value = runner1Data.distance || '';

                document.getElementById('runner2Status').value = runner2Data.status || 'skipped';
                const runner2Time = runner2Data.status === 'completed' ? runner2Data.time : (runner2Data.goalTime || runner2Data.time || '');
                document.getElementById('runner2Time').value = normalizeTime(runner2Time) ? secondsToTime(timeToSeconds(runner2Time)) : '';
                document.getElementById('runner2Distance').value = runner2Data.distance || '';
            } else {
                // Modo Criação
                dom.modalTitle.textContent = 'Adicionar Nova Corrida';
                document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
            }
            dom.modal.showModal();
        }

        function closeModal() { dom.modal.close(); }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentViewingUid || !authUser || currentViewingUid !== authUser.uid) {
                alert("Erro: Você deve estar logado para salvar.");
                return;
            }

            const id = document.getElementById('race-id').value;
            const date = document.getElementById('raceDate').value;
            
            const runner1TimeRaw = document.getElementById('runner1Time').value;
            const runner2TimeRaw = document.getElementById('runner2Time').value;
            const runner1Status = document.getElementById('runner1Status').value;
            const runner2Status = document.getElementById('runner2Status').value;
            
            const raceData = {
                date: date,
                year: new Date(date + 'T00:00:00').getFullYear().toString(),
                raceName: document.getElementById('raceName').value,
                distance: parseFloat(document.getElementById('raceDistance').value) || null,
                juntos: document.getElementById('raceJuntos').checked,
                notes: document.getElementById('raceNotes').value || null,
                // CORREÇÃO: Salva usando as chaves estáticas 'runner1' e 'runner2'
                [RUNNER_1_KEY]: {
                    status: runner1Status,
                    time: runner1Status === 'completed' ? normalizeTime(runner1TimeRaw) : null,
                    goalTime: runner1Status === 'planned' ? normalizeTime(runner1TimeRaw) : null,
                    distance: parseFloat(document.getElementById('runner1Distance').value) || null
                },
                [RUNNER_2_KEY]: {
                    status: runner2Status,
                    time: runner2Status === 'completed' ? normalizeTime(runner2TimeRaw) : null,
                    goalTime: runner2Status === 'planned' ? normalizeTime(runner2TimeRaw) : null,
                    distance: parseFloat(document.getElementById('runner2Distance').value) || null
                }
            };
            
            const dbPath = `/users/${currentViewingUid}/races/`;

            if (id) {
                // Atualiza
                firebase.database().ref(dbPath).child(id).set(raceData)
                    .then(closeModal)
                    .catch(err => {
                        console.error("Erro ao atualizar:", err);
                        alert("Erro ao salvar: " + err.message);
                    });
            } else {
                // Cria
                const newRaceRef = firebase.database().ref(dbPath).push();
                newRaceRef.set(raceData)
                    .then(closeModal)
                    .catch(err => {
                         console.error("Erro ao criar:", err);
                         alert("Erro ao salvar: " + err.message);
                    });
            }
        }

        function deleteRace(raceId) {
            if (!currentViewingUid || !authUser || currentViewingUid !== authUser.uid) {
                alert("Erro: Você deve estar logado para excluir.");
                return;
            }
            
            const race = db.races[raceId];
            if (!confirm(`Tem certeza que deseja excluir esta corrida?\n\n${race.raceName} (${race.date})`)) return;

            firebase.database().ref(`/users/${currentViewingUid}/races/`).child(raceId).remove()
                .then(closeModal)
                .catch(err => {
                    console.error("Erro ao excluir:", err);
                    alert("Erro ao excluir: " + err.message);
                });
        }

        /**
         * Renderiza todos os componentes da UI
         */
        function renderAll() {
            updateProfileUI(); // Atualiza nomes no cabeçalho e formulário
            renderDashboard();
            renderHistory();
        }
        
        // --- Funções de Carregamento de Dados (Firebase RTDB) ---

        /**
         * Carrega o perfil do UID especificado
         */
        function loadProfile(uid) {
            const profileRef = firebase.database().ref(`/users/${uid}/profile`);
            profileRef.on('value', (snapshot) => {
                const profileData = snapshot.val();
                if (profileData) {
                    db.profile = profileData;
                    renderAll(); 
                } else if (authUser && uid === authUser.uid) {
                    // Perfil não existe, criar um padrão para o novo usuário
                    const newProfile = {
                        runner1Name: authUser.displayName ? authUser.displayName.split(' ')[0] : "Corredor 1",
                        runner2Name: "Corredora 2",
                        teamName: "Minha Equipe"
                    };
                    profileRef.set(newProfile);
                    // O 'on' value listener será disparado novamente com os novos dados
                }
            });
        }
        
        /**
         * Carrega as corridas do UID especificado
         */
        function loadRaces(uid) {
            currentViewingUid = uid; 
            const racesRef = firebase.database().ref(`/users/${uid}/races`);
            
            db.races = {};
            renderAll(); 
            dom.historyContainer.innerHTML = '<div class="loader">Carregando histórico...</div>';
            
            racesRef.on('value', (snapshot) => {
                db.races = snapshot.val() || {};
                renderAll();
            });
        }

        /**
         * Carrega a visão pública (lista de perfis)
         */
        function loadPublicView() {
            dom.loginOrPublicView.classList.remove('hidden');
            dom.loginView.classList.add('hidden');
            dom.publicView.classList.remove('hidden');
            dom.userContent.classList.add('hidden'); 
            dom.headerSubtitle.textContent = "Selecione um currículo para visualizar";
            
            const publicProfilesRef = firebase.database().ref('/publicProfiles');
            publicProfilesRef.on('value', (snapshot) => {
                const profiles = snapshot.val();
                dom.publicProfileList.innerHTML = '';
                if(profiles) {
                    Object.entries(profiles).forEach(([uid, profile]) => {
                        const card = document.createElement('div');
                        card.className = 'profile-card';
                        card.innerHTML = `
                            <h3>${profile.runner1Name || 'Corredor 1'}</h3>
                            <h3 class="runner2-name">${profile.runner2Name || 'Corredor 2'}</h3>
                            <p>${profile.teamName || 'Equipe'}</p>
                        `;
                        card.addEventListener('click', () => {
                            dom.loginOrPublicView.classList.add('hidden');
                            dom.userContent.classList.remove('hidden');
                            loadProfile(uid); 
                            loadRaces(uid);
                        });
                        dom.publicProfileList.appendChild(card);
                    });
                } else {
                    dom.publicProfileList.innerHTML = '<div class="loader">Nenhum perfil público encontrado.</div>';
                }
            });
        }
        
        // --- Funções de Autenticação (Firebase Auth) ---

        function handleSignIn(e) {
            e.preventDefault();
            const email = dom.loginEmail.value;
            const password = dom.loginPassword.value;
            dom.loginError.classList.add('hidden');

            auth.signInWithEmailAndPassword(email, password)
                .catch(err => {
                    console.error("Erro no login:", err.code, err.message);
                    dom.loginError.textContent = "Erro: " + (err.code === 'auth/wrong-password' ? 'Senha incorreta.' : 'Usuário não encontrado.');
                    dom.loginError.classList.remove('hidden');
                });
        }

        function signOut() {
            auth.signOut().catch(err => console.error("Erro no logout:", err));
        }
        
        /**
         * Ponto de entrada principal da aplicação
         */
        document.addEventListener('DOMContentLoaded', () => {
            // VERIFICAÇÃO CRÍTICA
            if (!firebaseConfig.apiKey || !firebaseConfig.databaseURL) {
                alert("ERRO DE CONFIGURAÇÃO: O objeto firebaseConfig está incompleto.");
                document.body.innerHTML = '<h1 style="color:red; text-align:center; padding: 50px;">ERRO: O Firebase não foi configurado corretamente.</h1>';
                return;
            }

            // Inicializa o Firebase
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();

            // Listeners do Modal
            dom.btnAddnew.addEventListener('click', () => openModal());
            dom.btnCloseModal.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
            dom.btnCancel.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
            dom.form.addEventListener('submit', handleFormSubmit);
            dom.btnDelete.addEventListener('click', () => {
                const id = document.getElementById('race-id').value;
                if(id) deleteRace(id);
            });
            
            // Listeners de Autenticação
            dom.loginForm.addEventListener('submit', handleSignIn);
            dom.btnLogout.addEventListener('click', signOut);

            // Gerenciador Central de Estado de Autenticação
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // --- USUÁRIO LOGADO ---
                    authUser = user;
                    isAdmin = user.uid === '29d30W4RS1WzK4SWZRZ5pEFnOdm1'; 
                    
                    dom.btnLogout.classList.remove('hidden');
                    dom.userInfo.classList.remove('hidden');
                    dom.userEmail.textContent = user.email;
                    dom.controlsSection.classList.remove('hidden'); 
                    
                    dom.loginOrPublicView.classList.add('hidden');
                    dom.userContent.classList.remove('hidden');

                    // Carrega o perfil e as corridas DO USUÁRIO LOGADO
                    loadProfile(user.uid);
                    loadRaces(user.uid);

                } else {
                    // --- USUÁRIO ANÔNIMO (LOGGED OUT) ---
                    authUser = null;
                    isAdmin = false;
                    currentViewingUid = null;
                    
                    dom.btnLogout.classList.add('hidden');
                    dom.userInfo.classList.add('hidden');
                    dom.controlsSection.classList.add('hidden');
                    
                    // Exibe a tela de Login E a tela de Perfis Públicos
                    dom.loginOrPublicView.classList.remove('hidden');
                    dom.loginView.classList.remove('hidden');
                    dom.userContent.classList.add('hidden'); // Esconde dashboard
                    
                    db = { races: {}, profile: {} };
                    loadPublicView(); // Carrega os perfis públicos abaixo do login
                }
            });
        });

    </script>
</body>
</html>
