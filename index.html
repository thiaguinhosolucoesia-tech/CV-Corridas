<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currículo Esportivo de Corredores</title>
    
    <!-- SDKs do Firebase (OBRIGATÓRIO) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* Estilização Geral (Dark Mode) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1f2027 0%, #3a3a52 100%); min-height: 100vh; padding: 20px; color: #f0f0f0; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(42, 42, 58, 0.85); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); }
        .header { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; min-height: 1.2em; }
        #auth-container { padding: 20px; background: rgba(31, 32, 39, 0.7); text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .form-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
        #auth-container input, #auth-container select { padding: 10px 15px; border-radius: 8px; border: 1px solid #555; background: #333345; color: #f0f0f0; font-size: 0.9em; }
        #auth-container input:focus, #auth-container select:focus { outline: none; border-color: #667eea; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        #user-info { display: none; align-items: center; justify-content: center; gap: 20px; }
        #user-email { font-size: 1.1em; color: #fff; }
        #btn-logout { background: #dc3545; }
        #public-profile-selector { display: none; }
        #public-profile-selector label { margin-right: 10px; font-weight: 600; }
        #admin-panel { display: none; padding: 20px; background: rgba(126, 75, 162, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        #admin-panel h2 { text-align: center; margin-bottom: 15px; color: #f06292; }
        .pending-user { display: flex; justify-content: space-between; align-items: center; background: #2a2a3a; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .pending-user .btn { padding: 5px 10px; font-size: 0.9em; }
        .dashboard-section { padding: 30px; background: rgba(20, 20, 30, 0.5); }
        .dashboard-header { text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #c5cae9; }
        .dashboard-subheader { text-align: center; margin-bottom: 15px; color: #aaa; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #2a2a3a; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3); }
        .stat-number { font-size: 2em; font-weight: bold; color: #c5cae9; margin-bottom: 8px; line-height: 1.2; }
        .stat-label { color: #b0b0b0; font-weight: 600; font-size: 0.9em; }
        .pr-card .stat-number { font-size: 1.4em; }
        .pr-card .runner-pr { font-size: 0.9em; color: #f0f0f0; line-height: 1.5; }
        .pr-card .runner-pr-1 { color: #4dabf5; font-weight: 600; }
        .pr-card .runner-pr-2 { color: #f06292; font-weight: 600; }
        .controls-section { padding: 20px 30px; text-align: center; background: #1a1a2e; }
        .btn-add { padding: 15px 30px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3); }
        .btn-add:disabled { background: #6c757d; opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
        .history-section { padding: 30px; background: transparent; }
        .year-group { margin-bottom: 30px; }
        .year-title { font-size: 2em; color: #c5cae9; border-bottom: 3px solid #c5cae9; padding-bottom: 10px; margin-bottom: 20px; }
        .race-card-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .race-card { background: #2a2a3a; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.05); }
        .race-card.status-planned { background: #3a382a; border: 2px dashed #ffc107; }
        .race-card.status-skipped { background: #3a2a2a; opacity: 0.7; }
        .race-card-header { padding: 20px; border-bottom: 1px solid #444; }
        .race-card-header h3 { font-size: 1.3em; color: #ffffff; margin-bottom: 5px; }
        .race-card-header .date { font-size: 0.9em; color: #b0b0b0; font-weight: 600; }
        .race-card-body { padding: 20px; flex-grow: 1; }
        .runner-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #444; }
        .runner-info:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: 0; }
        .runner-info .runner-name { font-weight: bold; font-size: 1.1em; }
        .runner-info .runner-name.runner1 { color: #4dabf5; }
        .runner-info .runner-name.runner2 { color: #f06292; }
        .runner-details { text-align: right; }
        .runner-time { font-size: 1.2em; font-weight: 700; color: #4caf50; }
        .runner-time.goal { color: #ffc107; font-size: 1.1em; }
        .runner-time.skipped { color: #f44336; font-size: 1.1em; font-style: italic; }
        .runner-pace { font-size: 0.9em; color: #b0b0b0; font-family: monospace; }
        .runner-pace.goal { color: #ffeb3b; }
        .race-card-footer { padding: 10px 20px; background: #222230; display: flex; justify-content: space-between; align-items: center; }
        .juntos-icon { font-size: 1.5em; }
        .race-notes { font-size: 0.85em; color: #b0b0b0; font-style: italic; margin-left: 10px; }
        .race-distance { font-size: 1.1em; font-weight: bold; color: #c5cae9; margin-right: 15px; }
        .race-controls { display: flex; gap: 10px; }
        .race-controls.hidden { display: none; }
        .btn-control { background: none; border: none; cursor: pointer; font-size: 1em; color: #b0b0b0; opacity: 0.6; transition: opacity 0.3s; }
        .btn-control:hover { opacity: 1; }
        dialog { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 600px; padding: 0; overflow: hidden; background: #2a2a3a; color: #f0f0f0; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
        .modal-header { padding: 20px 30px; background: #1f2027; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { color: #c5cae9; }
        .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 600; color: #b0b0b0; font-size: 0.9em; margin-bottom: 8px; }
        .form-group input, .form-group select { padding: 12px 15px; border: 2px solid #555; border-radius: 10px; font-size: 1em; transition: all 0.3s ease; background: #333345; color: #f0f0f0; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .form-group.checkbox { grid-column: 1 / -1; flex-direction: row; align-items: center; gap: 10px; font-size: 1.1em; }
        .form-group.checkbox input { width: 20px; height: 20px; }
        .runner-form-group { border: 2px solid #555; border-radius: 10px; padding: 15px; }
        .runner-form-group h4 { font-size: 1.2em; margin-bottom: 15px; text-align: center; }
        .runner-form-group.runner1 h4 { color: #4dabf5; }
        .runner-form-group.runner2 h4 { color: #f06292; }
        .modal-footer { padding: 20px 30px; background: #1f2027; border-top: 1px solid #444; display: flex; justify-content: flex-end; gap: 15px; }
        #btn-delete { background: #dc3545; color: white; margin-right: auto; }
        #btn-delete:hover { background: #c82333; }
        #btn-delete.hidden { display: none; }
        .footer { background: #343a40; color: white; text-align: center; padding: 20px; font-size: 0.9em; }
        #loading-state { text-align: center; padding: 50px; font-size: 1.2em; color: #b0b0b0; }
        #loading-state.hidden { display: none; }
        @media (max-width: 768px) {
            body { padding: 10px; } .header h1 { font-size: 2em; } .form-container { flex-direction: column; gap: 15px; } .form-container input, .form-container select { width: 100%; }
            .form-container .btn { width: 100%; } .stats-grid { grid-template-columns: 1fr 1fr; } .race-card-list { grid-template-columns: 1fr; } .modal-body { grid-template-columns: 1fr; }
            .form-group.checkbox { font-size: 1em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Currículo Esportivo 🏃‍♂️🏃‍♀️</h1>
            <p id="header-subtitle">Carregando perfil...</p>
        </div>
        
        <div id="auth-container">
            <div id="public-profile-selector" class="form-container">
                <label for="profile-select">Visualizar Perfil Público:</label>
                <select id="profile-select" class="btn-secondary"></select>
            </div>
            <form id="login-form" class="form-container">
                <input type="email" id="login-email" placeholder="E-mail" required>
                <input type="password" id="login-pass" placeholder="Senha" required>
                <button type="submit" class="btn btn-primary">Login</button>
                <button type="button" id="btn-signup" class="btn btn-secondary">Cadastrar</button>
            </form>
            <div id="user-info" class="form-container">
                <span id="user-email"></span>
                <button type="button" id="btn-logout" class="btn">Logout</button>
            </div>
        </div>

        <div id="admin-panel">
            <h2>⚙️ Painel de Administração - Aprovações Pendentes</h2>
            <div id="pending-users-list"></div>
        </div>

        <div class="dashboard-section">
            <h2 class="dashboard-header">Dashboard de Performance</h2>
            <h3 class="dashboard-subheader">Recordes Pessoais (PRs)</h3>
            <div class="stats-grid" id="pr-grid"></div>
            <h3 class="dashboard-subheader" style="margin-top: 30px;">Estatísticas Gerais</h3>
            <div class="stats-grid" id="summary-grid"></div>
        </div>

        <div class="controls-section">
            <button class="btn-add" id="btn-add-new" disabled>Carregando...</button>
        </div>

        <div class="history-section">
            <div id="history-container">
                <div id="loading-state">Carregando histórico de corridas...</div>
            </div>
        </div>

        <div class="footer">
            Desenvolvido com 🤖 por <strong>thIAguinho Soluções</strong>
        </div>
    </div>

    <dialog id="race-modal">
        <form id="race-form">
            <input type="hidden" id="race-id">
            <div class="modal-header">
                <h2 id="modal-title">Adicionar Nova Corrida</h2>
                <button type="button" class="btn-control" id="btn-close-modal" aria-label="Fechar">✖️</button>
            </div>
            
            <div class="modal-body">
                 <div class="form-group full-width">
                    <label for="raceName">Nome da Corrida</label>
                    <input type="text" id="raceName" required>
                </div>
                <div class="form-group">
                    <label for="raceDate">Data</label>
                    <input type="date" id="raceDate" required>
                </div>
                <div class="form-group">
                    <label for="raceDistance">Distância Principal (km)</label>
                    <input type="number" step="0.1" id="raceDistance" placeholder="Ex: 5 ou 10">
                </div>
                
                <div class="runner-form-group runner1">
                    <h4 id="runner1-form-name">Corredor 1</h4>
                    <div class="form-group">
                        <label for="runner1Status">Status</label>
                        <select id="runner1Status">
                            <option value="completed">Completou ✅</option>
                            <option value="planned">Planejada ⏳</option>
                            <option value="skipped">Não Correu ❌</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="runner1Time">Tempo (HH:MM:SS)</label>
                        <input type="text" id="runner1Time" placeholder="00:29:10">
                    </div>
                    <div class="form-group">
                        <label for="runner1Distance">Distância (se diferente)</label>
                        <input type="number" step="0.1" id="runner1Distance" placeholder="Ex: 10">
                    </div>
                </div>
                
                <div class="runner-form-group runner2">
                    <h4 id="runner2-form-name">Corredor 2</h4>
                    <div class="form-group">
                        <label for="runner2Status">Status</label>
                        <select id="runner2Status">
                            <option value="completed">Completou ✅</option>
                            <option value="planned">Planejada ⏳</option>
                            <option value="skipped">Não Correu ❌</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="runner2Time">Tempo (HH:MM:SS)</label>
                        <input type="text" id="runner2Time" placeholder="00:40:36">
                    </div>
                    <div class="form-group">
                        <label for="runner2Distance">Distância (se diferente)</label>
                        <input type="number" step="0.1" id="runner2Distance" placeholder="Ex: 5">
                    </div>
                </div>
                
                <div class="form-group checkbox">
                    <input type="checkbox" id="raceJuntos">
                    <label for="raceJuntos">Correram Juntos? 👩🏻‍❤️‍👨🏻</label>
                </div>
                
                <div class="form-group full-width">
                    <label for="raceNotes">Notas</label>
                    <input type="text" id="raceNotes" placeholder="Ex: ♿ Pernas Solidárias, meta...">
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn" id="btn-delete" class="hidden">Excluir</button>
                <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="btn-save">Salvar</button>
            </div>
        </form>
    </dialog>


    <script>
        // =================================================================
        // CONFIGURAÇÃO DO FIREBASE (Valores Reais)
        // =================================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyD4f2an3vC3v17VOwjo23C2PfCwl-PxPc8",
            authDomain: "curriculo-corridas.firebaseapp.com",
            databaseURL: "https://curriculo-corridas-default-rtdb.firebaseio.com",
            projectId: "curriculo-corridas",
            storageBucket: "curriculo-corridas.appspot.com",
            messagingSenderId: "623733303687",
            appId: "1:623733303687:web:68f6c446eebbfec2590b22"
        };
        
        const ADMIN_UID = "6awggCOZt3P8ARkRytKFuc8v6yz1";
        const PUBLIC_PROFILE_UID_TO_VIEW = ADMIN_UID; 

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // =================================================================
        // ESTADO GLOBAL DA APLICAÇÃO
        // =================================================================
        let localRaces = []; 
        let currentUser = null; 
        let viewingUserID = null; 
        let currentProfile = {};
        let profileRef = null;
        let racesRef = null;
        let pendingUsersRef = null;

        // =================================================================
        // DADOS INICIAIS PARA NOVOS USUÁRIOS (HISTÓRICO COMPLETO)
        // =================================================================
        const initialRaceData = [
            // 2023
            { date: '2023-08-20', year: '2023', raceName: 'Corrida FreshRun - Muffato RP', distance: 5, juntos: false, notes: '', runner1: { status: 'completed', time: '00:29:10' }, runner2: { status: 'completed', time: '00:40:36' } },
            // 2024
            { date: '2024-03-24', year: '2024', raceName: 'Corrida Instituto Unimed RP', distance: 5, juntos: false, notes: '', runner1: { status: 'completed', time: '00:26:11' }, runner2: { status: 'completed', time: '00:37:42' } },
            { date: '2024-05-19', year: '2024', raceName: 'Corrida Maio Amarelo RP', distance: null, juntos: false, notes: 'Thiago 7k', runner1: { status: 'completed', time: '00:42:35', distance: 7 }, runner2: { status: 'skipped' } },
            { date: '2024-06-02', year: '2024', raceName: 'Circuito Sesc de Corridas RP', distance: 5, juntos: true, notes: '', runner1: { status: 'completed', time: '00:39:02' }, runner2: { status: 'completed', time: '00:39:02' } },
            { date: '2024-08-18', year: '2024', raceName: 'Corrida Muffato RP', distance: null, juntos: false, notes: 'Thiago 10k, Thamis 5k', runner1: { status: 'completed', time: '00:55:59', distance: 10 }, runner2: { status: 'completed', time: '00:39:05', distance: 5 } },
            { date: '2024-08-25', year: '2024', raceName: 'Circuito Mais Mulher SP / RP', distance: 5, juntos: false, notes: '', runner1: { status: 'skipped' }, runner2: { status: 'completed', time: '00:39:45' } },
            { date: '2024-09-29', year: '2024', raceName: 'Desafio Extremo Sesc RP', distance: 2, juntos: false, notes: '', runner1: { status: 'completed', time: null }, runner2: { status: 'skipped' } },
            { date: '2024-11-10', year: '2024', raceName: '5ª CORRIDA E CAMINHADA 17° BPM/I RP', distance: null, juntos: false, notes: 'Thiago 10k', runner1: { status: 'completed', time: '00:55:57', distance: 10 }, runner2: { status: 'skipped' } },
            { date: '2024-11-25', year: '2024', raceName: 'Circuito Corrida de Rua Santander RP', distance: 5, juntos: false, notes: '', runner1: { status: 'completed', time: '00:27:10' }, runner2: { status: 'completed', time: '00:39:13' } },
            { date: '2024-12-01', year: '2024', raceName: 'ROCK AND RUN RP', distance: 5, juntos: true, notes: '', runner1: { status: 'completed', time: '00:40:05' }, runner2: { status: 'completed', time: '00:40:05' } },
            // 2025
            { date: '2025-02-02', year: '2025', raceName: 'Corrida Circuito Marilson RP', distance: 5, juntos: false, notes: 'Thiago PR 🔝', runner1: { status: 'completed', time: '00:26:02' }, runner2: { status: 'completed', time: '00:36:36' } },
            { date: '2025-03-31', year: '2025', raceName: 'Corrida da Polícia Federal RP', distance: 5, juntos: false, notes: 'Thiago ♿ Pernas Solidárias - Instituto Unimed', runner1: { status: 'completed', time: '00:38:30' }, runner2: { status: 'completed', time: '00:37:49' } },
            { date: '2025-04-13', year: '2025', raceName: 'Treino Solidário AMICC RP', distance: 5, juntos: true, notes: '', runner1: { status: 'completed', time: '00:38:05' }, runner2: { status: 'completed', time: '00:38:05' } },
            { date: '2025-05-01', year: '2025', raceName: '46ª Corrida Pedestre do Trabalhador Olímpia - SP', distance: null, juntos: false, notes: 'Thiago 7k PR 🔝', runner1: { status: 'completed', time: '00:39:42', distance: 7 }, runner2: { status: 'skipped' } },
            { date: '2025-05-17', year: '2025', raceName: 'Corrida Maio Amarelo RP', distance: 5, juntos: false, notes: '', runner1: { status: 'completed', time: '00:27:05' }, runner2: { status: 'completed', time: '00:38:35' } },
            { date: '2025-05-25', year: '2025', raceName: 'Corrrida Track Field/Santander RP', distance: null, juntos: false, notes: 'Thiago 10k PR 🔝', runner1: { status: 'completed', time: '00:54:30', distance: 10 }, runner2: { status: 'completed', time: '00:37:53', distance: 5 } },
            { date: '2025-06-01', year: '2025', raceName: 'Circuito Sesc de Corridas RP', distance: 5, juntos: true, notes: 'Thiago PR 🔝, Thamis PR 🔝🔝', runner1: { status: 'completed', time: '00:36:06' }, runner2: { status: 'completed', time: '00:36:06' } },
            { date: '2025-07-27', year: '2025', raceName: 'Corrida Circuito Sesc - Catanduva', distance: 6, juntos: true, notes: '', runner1: { status: 'completed', time: '00:49:22' }, runner2: { status: 'completed', time: '00:49:22' } },
            { date: '2025-08-03', year: '2025', raceName: 'FreshRun - corrida Muffato', distance: null, juntos: false, notes: 'Thiago 12k PR 🔝, Thamis 6k PR 🔝', runner1: { status: 'completed', time: '01:07:00', distance: 12 }, runner2: { status: 'completed', time: '00:46:31', distance: 6 } },
            { date: '2025-09-07', year: '2025', raceName: 'Corrida da Independência - Uchôa', distance: 5, juntos: false, notes: '', runner1: { status: 'planned' }, runner2: { status: 'planned' } },
            { date: '2025-09-14', year: '2025', raceName: '6ª CORRIDA E CAMINHADA 17° BPM/I RP', distance: null, juntos: false, notes: '', runner1: { status: 'planned', distance: 17 }, runner2: { status: 'planned', distance: 5 } },
            { date: '2025-10-19', year: '2025', raceName: 'Corrida Sin Comerciários', distance: 5, juntos: false, notes: '', runner1: { status: 'planned' }, runner2: { status: 'planned' } },
            { date: '2025-11-30', year: '2025', raceName: 'Corrida Instituto Unimed - Rio Preto', distance: null, juntos: false, notes: '', runner1: { status: 'planned', distance: 16 }, runner2: { status: 'planned', distance: 5 } }
        ];
        
        // Funções Utilitárias...
        function timeToSeconds(t) { if (!t || typeof t !== 'string') return null; const p = t.split(':').map(Number); let s = 0; if (p.length === 2) s = p[0] * 60 + p[1]; else if (p.length === 3) s = p[0] * 3600 + p[1] * 60 + p[2]; else return null; return s; }
        function secondsToTime(s) { if (s === null || isNaN(s) || s === Infinity) return 'N/A'; s = Math.round(s); const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = s % 60; const pad = n => String(n).padStart(2, '0'); return h > 0 ? `${pad(h)}:${pad(m)}:${pad(sec)}` : `${pad(m)}:${pad(sec)}`; }
        function normalizeTime(t) { if (!t) return null; const c = t.replace(/[^0-9:]/g, ''); const p = c.split(':'); if (p.length === 2) return `00:${String(p[0]).padStart(2,'0')}:${String(p[1]).padStart(2,'0')}`; else if (p.length === 3) return `${String(p[0]).padStart(2,'0')}:${String(p[1]).padStart(2,'0')}:${String(p[2]).padStart(2,'0')}`; return null; }
        function calculatePace(t, d) { const s = timeToSeconds(t); const dist = parseFloat(d); if (!s || !dist || dist <= 0) return 'N/A'; const pS = s / dist; const pM = Math.floor(pS / 60); const pSec = Math.round(pS % 60); return `${String(pM).padStart(2,'0')}:${String(pSec).padStart(2,'0')} /km`; }

        // Lógica de Autenticação e Dados (Firebase)
        function setupUIForAuthState(user) {
            if (profileRef) profileRef.off(); if (racesRef) racesRef.off(); if (pendingUsersRef) pendingUsersRef.off();
            const btnAdd = document.getElementById('btn-add-new'), adminPanel = document.getElementById('admin-panel'), publicSelector = document.getElementById('public-profile-selector'), loginForm = document.getElementById('login-form'), userInfo = document.getElementById('user-info');
            adminPanel.style.display = 'none';
            if (user) {
                currentUser = user; viewingUserID = user.uid;
                userInfo.style.display = 'flex'; loginForm.style.display = 'none'; publicSelector.style.display = 'none';
                document.getElementById('user-email').textContent = `${user.email}`; btnAdd.disabled = false; btnAdd.textContent = '➕ Adicionar Nova Corrida';
                if (user.uid === ADMIN_UID) { adminPanel.style.display = 'block'; loadPendingUsers(); }
                loadUserProfile(user.uid);
            } else {
                currentUser = null;
                userInfo.style.display = 'none'; loginForm.style.display = 'flex'; publicSelector.style.display = 'block';
                btnAdd.disabled = true; btnAdd.textContent = 'Faça login para adicionar corridas';
                loadApprovedUsersAndSetInitialView();
            }
        }

        function loadApprovedUsersAndSetInitialView() {
            db.ref('approved_users').once('value', s => {
                const users = s.val(), select = document.getElementById('profile-select');
                select.innerHTML = '<option value="">Selecione um perfil...</option>';
                if (users) {
                    Object.keys(users).forEach(uid => {
                        const option = document.createElement('option');
                        option.value = uid; option.textContent = `${users[uid].runner1_name} & ${users[uid].runner2_name}`;
                        if (uid === PUBLIC_PROFILE_UID_TO_VIEW) option.selected = true;
                        select.appendChild(option);
                    });
                }
                viewingUserID = select.value || null;
                if (viewingUserID) loadUserProfile(viewingUserID);
                else { document.getElementById('header-subtitle').textContent = 'Plataforma de Corredores'; document.getElementById('history-container').innerHTML = `<div id="loading-state">Nenhum perfil público disponível.</div>`; }
            });
        }
        
        function loadUserProfile(uid) {
            profileRef = db.ref(`users/${uid}/profile`); racesRef = db.ref(`users/${uid}/races`);
            profileRef.on('value', s => {
                const data = s.val(); if(data) {
                    currentProfile = { runner1_name: data.runner1_name || 'Corredor 1', runner1_nameShort: data.runner1_name ? data.runner1_name.split(' ')[0] : 'C1', runner1_emoji: "🏃‍♂️", runner2_name: data.runner2_name || 'Corredor 2', runner2_nameShort: data.runner2_name ? data.runner2_name.split(' ')[0] : 'C2', runner2_emoji: "🏃‍♀️", team_name: data.team_name || 'Equipe' };
                }
                updateHeaderAndFormNames(); renderAll();
            });
            racesRef.on('value', s => {
                const data = s.val();
                if (data) {
                    localRaces = Object.keys(data).map(key => ({ id: key, ...data[key] })).sort((a, b) => new Date(b.date) - new Date(a.date));
                } else {
                    if (currentUser && currentUser.uid === uid) { populateNewUser(uid); } else { localRaces = []; }
                }
                renderAll();
            });
        }
        
        function populateNewUser(uid) {
            const racesAsObject = initialRaceData.reduce((acc, race) => {
                const newKey = db.ref().push().key; 
                const raceData = { ...race }; delete raceData.id;
                acc[newKey] = raceData;
                return acc;
            }, {});
            db.ref(`users/${uid}/races`).set(racesAsObject);
        }

        function loadPendingUsers() {
            pendingUsersRef = db.ref('pending_users'); pendingUsersRef.on('value', s => {
                const list = document.getElementById('pending-users-list'); list.innerHTML = ''; const users = s.val();
                if (!users) { list.innerHTML = '<p style="text-align: center; color: #aaa;">Nenhum cadastro pendente.</p>'; return; }
                Object.keys(users).forEach(uid => {
                    const user = users[uid];
                    const userDiv = document.createElement('div'); userDiv.className = 'pending-user';
                    userDiv.innerHTML = `<span>${user.email} (${user.runner1_name} & ${user.runner2_name})</span><div><button class="btn btn-primary approve-btn" data-uid="${uid}">Aprovar</button><button class="btn btn-secondary reject-btn" data-uid="${uid}" style="background:#dc3545;">Rejeitar</button></div>`;
                    list.appendChild(userDiv);
                });
                document.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', e => approveUser(e.target.dataset.uid)));
                document.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', e => rejectUser(e.target.dataset.uid)));
            });
        }
        
        function renderDashboard() {
            const prGrid = document.getElementById('pr-grid'), summaryGrid = document.getElementById('summary-grid');
            const prs = { runner1: {}, runner2: {} };
            const distances = [2, 5, 6, 7, 10, 12, 16, 17];
            let totalKmR1 = 0, totalKmR2 = 0, totalRacesJuntos = 0, completedRaces = 0;
            
            distances.forEach(d => {
                prs.runner1[d] = { time: 'N/A', seconds: Infinity };
                prs.runner2[d] = { time: 'N/A', seconds: Infinity };
            });

            localRaces.forEach(race => {
                if (race.juntos && race.runner1 && race.runner1.status === 'completed' && race.runner2 && race.runner2.status === 'completed') {
                    totalRacesJuntos++;
                }

                if (race.runner1 && race.runner1.status === 'completed') {
                    if(!race.runner2 || race.runner2.status !== 'completed') completedRaces++;
                    const dist = race.runner1.distance || race.distance;
                    const timeSec = timeToSeconds(race.runner1.time);
                    if (dist) totalKmR1 += dist;
                    if (prs.runner1[dist] && timeSec < prs.runner1[dist].seconds) {
                        prs.runner1[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
                
                if (race.runner2 && race.runner2.status === 'completed') {
                    completedRaces++;
                    const dist = race.runner2.distance || race.distance;
                    const timeSec = timeToSeconds(race.runner2.time);
                    if (dist) totalKmR2 += dist;
                    if (prs.runner2[dist] && timeSec < prs.runner2[dist].seconds) {
                        prs.runner2[dist] = { seconds: timeSec, time: secondsToTime(timeSec) };
                    }
                }
            });
            
            prGrid.innerHTML = distances.map(d => `
                <div class="stat-card pr-card">
                    <div class="stat-label">PR ${d}km</div>
                    <div class="stat-number">
                        <div class="runner-pr"><span class="runner-pr-1">${currentProfile.runner1_nameShort}: ${prs.runner1[d].time}</span></div>
                        <div class="runner-pr"><strong class="runner-pr-2">${currentProfile.runner2_nameShort}: ${prs.runner2[d].time}</strong></div>
                    </div>
                </div>
            `).join('');

            summaryGrid.innerHTML = `
                <div class="stat-card"><div class="stat-number">${completedRaces}</div><div class="stat-label">Corridas Concluídas</div></div>
                <div class="stat-card"><div class="stat-number">${totalRacesJuntos} 👩🏻‍❤️‍👨🏻</div><div class="stat-label">Corridas Juntos</div></div>
                <div class="stat-card"><div class="stat-number">${(totalKmR1 + totalKmR2).toFixed(1)} km</div><div class="stat-label">Total KM (Casal)</div></div>
                <div class="stat-card"><div class="stat-number"><span class="runner-pr-1">${totalKmR1.toFixed(1)}</span> / <strong class="runner-pr-2">${totalKmR2.toFixed(1)}</strong></div><div class="stat-label">Total KM (${currentProfile.runner1_nameShort}/${currentProfile.runner2_nameShort})</div></div>
            `;
        }

        function renderHistory() {
            const container = document.getElementById('history-container'), loading = document.getElementById('loading-state');
            container.innerHTML = '';
            if (localRaces.length === 0 && viewingUserID) {
                loading.textContent = "Nenhuma corrida encontrada para este perfil.";
                container.appendChild(loading);
                loading.classList.remove('hidden');
                return;
            } else if (!viewingUserID) {
                loading.textContent = "Selecione um perfil para visualizar.";
                container.appendChild(loading);
                loading.classList.remove('hidden');
                return;
            }
            loading.classList.add('hidden');
            const racesByYear = localRaces.reduce((acc, race) => {
                const year = race.year;
                if (!acc[year]) acc[year] = [];
                acc[year].push(race);
                return acc;
            }, {});
            const sortedYears = Object.keys(racesByYear).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                const yearGroup = document.createElement('div');
                yearGroup.className = 'year-group';
                const yearEmoji = `2️⃣0️⃣${year.slice(2)}`;
                yearGroup.innerHTML = `<h2 class="year-title">${yearEmoji} (${racesByYear[year].length} provas)</h2>`;
                const raceList = document.createElement('div');
                raceList.className = 'race-card-list';
                racesByYear[year].forEach(race => raceList.appendChild(createRaceCard(race)));
                yearGroup.appendChild(raceList);
                container.appendChild(yearGroup);
            });
        }
        
        function createRaceCard(race) {
            const card = document.createElement('div');
            let cardStatus = 'completed';
            if ((race.runner1 && race.runner1.status === 'planned') || (race.runner2 && race.runner2.status === 'planned')) { cardStatus = 'planned'; }
            if ((!race.runner1 || race.runner1.status === 'skipped') && (!race.runner2 || race.runner2.status === 'skipped')) { cardStatus = 'skipped'; }
            card.className = `race-card status-${cardStatus}`;
            card.dataset.id = race.id;
            const runner1Dist = (race.runner1 && race.runner1.distance) || race.distance;
            const runner2Dist = (race.runner2 && race.runner2.distance) || race.distance;
            const runner1Pace = (race.runner1 && race.runner1.status === 'completed') ? calculatePace(race.runner1.time, runner1Dist) : null;
            const runner2Pace = (race.runner2 && race.runner2.status === 'completed') ? calculatePace(race.runner2.time, runner2Dist) : null;
            let raceDistDisplay = race.distance ? `${race.distance}km` : (runner1Dist && runner2Dist && runner1Dist !== runner2Dist ? `${runner1Dist || '?'}k/${runner2Dist || '?'}k` : `${runner1Dist || runner2Dist || '?'}km`);
            const showControls = (currentUser && currentUser.uid === viewingUserID);
            card.innerHTML = `
                <div class="race-card-header"><h3>${race.raceName}</h3><span class="date">${new Date(race.date).toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' })}</span></div>
                <div class="race-card-body">
                    ${createRunnerInfoHTML(currentProfile.runner1_name, 'runner1', race.runner1, runner1Dist, runner1Pace, '🏃‍♂️')}
                    ${createRunnerInfoHTML(currentProfile.runner2_name, 'runner2', race.runner2, runner2Dist, runner2Pace, '🏃‍♀️')}
                </div>
                <div class="race-card-footer">
                    <div><span class="juntos-icon">${race.juntos ? '👩🏻‍❤️‍👨🏻' : ''}</span><span class="race-notes">${race.notes || ''}</span></div>
                    <div style="display: flex; align-items: center;">
                        <span class="race-distance">${raceDistDisplay}</span>
                        <div class="race-controls ${showControls ? '' : 'hidden'}">
                            <button class="btn-control btn-edit" title="Editar">✏️</button><button class="btn-control btn-delete" title="Excluir">🗑️</button>
                        </div>
                    </div>
                </div>`;
            if (showControls) {
                card.querySelector('.btn-edit').addEventListener('click', () => openModal(race.id));
                card.querySelector('.btn-delete').addEventListener('click', () => deleteRace(race.id));
            }
            return card;
        }

        function createRunnerInfoHTML(name, runnerClass, runnerData, distance, pace, emoji) {
            let timeHTML = '', paceHTML = '';
            runnerData = runnerData || { status: 'skipped' };
            switch (runnerData.status) {
                case 'completed':
                    const time = secondsToTime(timeToSeconds(runnerData.time));
                    timeHTML = `<div class="runner-time">${time !== 'N/A' ? time : '✅'}</div>`;
                    if (pace && pace !== 'N/A') paceHTML = `<div class="runner-pace">${pace}</div>`;
                    break;
                case 'planned':
                    const goalTime = runnerData.goalTime || (runnerData.time && runnerData.time.includes(':') ? runnerData.time : null);
                    timeHTML = `<div class="runner-time goal">⏳ ${goalTime ? secondsToTime(timeToSeconds(goalTime)) : 'Planejada'}</div>`;
                    if (pace && pace !== 'N/A') paceHTML = `<div class="runner-pace goal">(Meta: ${pace})</div>`;
                    break;
                default:
                    timeHTML = `<div class="runner-time skipped">❌ Não correu</div>`;
            }
            return `<div class="runner-info"><span class="runner-name ${runnerClass}">${name} ${emoji}</span><div class="runner-details">${timeHTML}${paceHTML}</div></div>`;
        }
        
        function openModal(raceId = null) {
            if (!currentUser) return;
            form.reset();
            document.getElementById('race-id').value = '';
            btnDelete.classList.add('hidden');
            document.getElementById('runner1-form-name').innerHTML = `${currentProfile.runner1_name} ${currentProfile.runner1_emoji}`;
            document.getElementById('runner2-form-name').innerHTML = `${currentProfile.runner2_name} ${currentProfile.runner2_emoji}`;

            if (raceId) {
                modalTitle.textContent = 'Editar Corrida';
                btnDelete.classList.remove('hidden');
                const race = localRaces.find(r => r.id === raceId);
                if (!race) return;
                document.getElementById('race-id').value = race.id;
                document.getElementById('raceName').value = race.raceName;
                document.getElementById('raceDate').value = race.date;
                document.getElementById('raceDistance').value = race.distance;
                document.getElementById('raceJuntos').checked = race.juntos;
                document.getElementById('raceNotes').value = race.notes || '';
                
                if (race.runner1) {
                    document.getElementById('runner1Status').value = race.runner1.status || 'skipped';
                    const runner1Time = race.runner1.status === 'completed' ? race.runner1.time : (race.runner1.goalTime || race.runner1.time || '');
                    document.getElementById('runner1Time').value = normalizeTime(runner1Time) ? secondsToTime(timeToSeconds(runner1Time)) : '';
                    document.getElementById('runner1Distance').value = race.runner1.distance || '';
                }
                if (race.runner2) {
                    document.getElementById('runner2Status').value = race.runner2.status || 'skipped';
                    const runner2Time = race.runner2.status === 'completed' ? race.runner2.time : (race.runner2.goalTime || race.runner2.time || '');
                    document.getElementById('runner2Time').value = normalizeTime(runner2Time) ? secondsToTime(timeToSeconds(runner2Time)) : '';
                    document.getElementById('runner2Distance').value = race.runner2.distance || '';
                }
            } else {
                modalTitle.textContent = 'Adicionar Nova Corrida';
                document.getElementById('raceDate').value = new Date().toISOString().split('T')[0];
            }
            modal.showModal();
        }
        function closeModal() { modal.close(); }

        function handleFormSubmit(e) {
            e.preventDefault(); if (!currentUser) return;
            const id = document.getElementById('race-id').value, raceId = id || db.ref().push().key;
            const newRace = { date: document.getElementById('raceDate').value, year: new Date(document.getElementById('raceDate').value + 'T00:00:00').getFullYear().toString(), raceName: document.getElementById('raceName').value, distance: parseFloat(document.getElementById('raceDistance').value) || null, juntos: document.getElementById('raceJuntos').checked, notes: document.getElementById('raceNotes').value || null,
                runner1: { status: document.getElementById('runner1Status').value, time: document.getElementById('runner1Status').value === 'completed' ? normalizeTime(document.getElementById('runner1Time').value) : null, goalTime: document.getElementById('runner1Status').value === 'planned' ? normalizeTime(document.getElementById('runner1Time').value) : null, distance: parseFloat(document.getElementById('runner1Distance').value) || null },
                runner2: { status: document.getElementById('runner2Status').value, time: document.getElementById('runner2Status').value === 'completed' ? normalizeTime(document.getElementById('runner2Time').value) : null, goalTime: document.getElementById('runner2Status').value === 'planned' ? normalizeTime(document.getElementById('runner2Time').value) : null, distance: parseFloat(document.getElementById('runner2Distance').value) || null } };
            db.ref(`users/${currentUser.uid}/races/${raceId}`).set(newRace).then(closeModal).catch(err => alert("Erro: " + err.message));
        }

        function deleteRace(raceId) {
            if (!currentUser) return; const race = localRaces.find(r => r.id === raceId); if (!confirm(`Excluir "${race.raceName}"?`)) return;
            db.ref(`users/${currentUser.uid}/races/${raceId}`).remove().then(closeModal).catch(err => alert("Erro: " + err.message));
        }
        
        function approveUser(uid) {
            const pendingUserRef = db.ref(`pending_users/${uid}`);
            pendingUserRef.once('value', s => {
                const userData = s.val(); if (!userData) return;
                db.ref(`approved_users/${uid}`).set({ runner1_name: userData.runner1_name, runner2_name: userData.runner2_name, email: userData.email });
                const profileData = { runner1_name: userData.runner1_name, runner2_name: userData.runner2_name, email: userData.email, team_name: "Nova Equipe" };
                db.ref(`users/${uid}/profile`).set(profileData).then(() => {
                    populateNewUser(uid);
                    pendingUserRef.remove();
                });
            });
        }
        function rejectUser(uid) { if (!confirm("Rejeitar cadastro?")) return; db.ref(`pending_users/${uid}`).remove(); alert("Usuário rejeitado. Remova-o manualmente da aba 'Authentication' no Firebase."); }
        
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('race-modal');
            const form = document.getElementById('race-form');
            const btnDelete = document.getElementById('btn-delete');
            
            auth.onAuthStateChanged(setupUIForAuthState);
            document.getElementById('btn-add-new').addEventListener('click', () => openModal());
            document.getElementById('btn-close-modal').addEventListener('click', e => { e.preventDefault(); closeModal(); });
            document.getElementById('btn-cancel').addEventListener('click', e => { e.preventDefault(); closeModal(); });
            form.addEventListener('submit', handleFormSubmit);
            btnDelete.addEventListener('click', () => { if (document.getElementById('race-id').value) deleteRace(document.getElementById('race-id').value); });
            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); const email = document.getElementById('login-email').value, pass = document.getElementById('login-pass').value; auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Erro no login: " + err.message)); });
            document.getElementById('btn-signup').addEventListener('click', () => {
                const email = document.getElementById('login-email').value, pass = document.getElementById('login-pass').value;
                if (!email || !pass || pass.length < 6) { alert("Preencha e-mail e senha (mínimo 6 caracteres)."); return; }
                const r1 = prompt("Nome do Corredor 1 (ex: Thiago):", ""); const r2 = prompt("Nome do Corredor 2 (ex: Thamis):", "");
                if (!r1 || !r2) return;
                auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                    db.ref(`pending_users/${cred.user.uid}`).set({ email: email, runner1_name: r1, runner2_name: r2, requestedAt: firebase.database.ServerValue.TIMESTAMP });
                    alert("Cadastro enviado! Aguarde a aprovação do administrador para fazer login."); auth.signOut();
                }).catch(err => alert("Erro ao cadastrar: " + err.message));
            });
            document.getElementById('btn-logout').addEventListener('click', () => auth.signOut());
            document.getElementById('profile-select').addEventListener('change', e => { if (e.target.value) { viewingUserID = e.target.value; loadUserProfile(e.target.value); } });
        });
    </script>
</body>
</html>

